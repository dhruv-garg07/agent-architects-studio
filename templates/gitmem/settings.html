{% extends "base.html" %}

{% block title %}Settings - {{ agent.name if agent else 'Unknown' }} | GitMem{% endblock %}

{% block content %}
<div class="relative min-h-screen bg-transparent text-foreground overflow-hidden">
    <!-- Mesh Gradients Background -->
    <div class="absolute inset-0 pointer-events-none">
        <div class="absolute top-0 left-1/4 w-96 h-96 bg-violet-500/10 rounded-full blur-3xl"></div>
        <div class="absolute bottom-0 right-1/4 w-80 h-80 bg-red-500/5 rounded-full blur-3xl"></div>
    </div>

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 relative z-10">

        <!-- Breadcrumb & Header -->
        <div class="mb-8">
            <nav class="flex items-center text-sm text-gray-400 mb-2 space-x-2">
                <a href="{{ url_for('gitmem.landing') }}" class="hover:text-white transition-colors">GitMem</a>
                <i data-lucide="chevron-right" class="w-4 h-4"></i>
                <a href="{{ url_for('gitmem.agent_dashboard', agent_id=agent.id) }}"
                    class="hover:text-white transition-colors">Repository</a>
                <i data-lucide="chevron-right" class="w-4 h-4"></i>
                <span class="text-white font-medium">Settings</span>
            </nav>
            <div class="flex items-center gap-4">
                <div
                    class="w-14 h-14 rounded-2xl bg-gradient-to-br from-gray-800 to-gray-900 border border-white/10 flex items-center justify-center text-xl font-bold text-white shadow-inner">
                    {{ agent.name[:2]|upper if agent and agent.name else (agent.id[:2]|upper if agent and agent.id else
                    '??') }}
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-white tracking-tight">{{ agent.name if agent else 'Unknown Agent'
                        }}</h1>
                    <p class="text-sm text-gray-400 mt-1">Repository Settings</p>
                </div>
            </div>
        </div>

        <!-- Repository Navigation -->
        <div class="border-b border-white/10 mb-8">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <a href="{{ url_for('gitmem.agent_dashboard', agent_id=agent.id) }}"
                    class="border-transparent text-gray-400 hover:text-gray-300 hover:border-gray-300 group inline-flex items-center py-4 px-1 border-b-2 font-medium text-sm transition-all duration-200">
                    <i data-lucide="brain" class="mr-2 -ml-0.5 h-4 w-4 text-gray-500 group-hover:text-gray-400"></i>
                    <span>Context</span>
                </a>

                <a href="{{ url_for('gitmem.agent_commits', agent_id=agent.id) }}"
                    class="border-transparent text-gray-400 hover:text-gray-300 hover:border-gray-300 group inline-flex items-center py-4 px-1 border-b-2 font-medium text-sm transition-all duration-200">
                    <i data-lucide="git-commit"
                        class="mr-2 -ml-0.5 h-4 w-4 text-gray-500 group-hover:text-gray-400"></i>
                    <span>Commits</span>
                </a>

                <a href="{{ url_for('gitmem.pulls', agent_id=agent.id) }}"
                    class="border-transparent text-gray-400 hover:text-gray-300 hover:border-gray-300 group inline-flex items-center py-4 px-1 border-b-2 font-medium text-sm transition-all duration-200">
                    <i data-lucide="git-pull-request"
                        class="mr-2 -ml-0.5 h-4 w-4 text-gray-500 group-hover:text-gray-400"></i>
                    <span>Pulls</span>
                </a>

                <a href="{{ url_for('gitmem.issues', agent_id=agent.id) }}"
                    class="border-transparent text-gray-400 hover:text-gray-300 hover:border-gray-300 group inline-flex items-center py-4 px-1 border-b-2 font-medium text-sm transition-all duration-200">
                    <i data-lucide="circle-dot"
                        class="mr-2 -ml-0.5 h-4 w-4 text-gray-500 group-hover:text-gray-400"></i>
                    <span>Issues</span>
                </a>

                <a href="{{ url_for('gitmem.settings', agent_id=agent.id) }}"
                    class="border-violet-500 text-white group inline-flex items-center py-4 px-1 border-b-2 font-medium text-sm">
                    <i data-lucide="settings" class="mr-2 -ml-0.5 h-4 w-4 text-violet-400"></i>
                    <span>Settings</span>
                </a>
            </nav>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Sidebar -->
            <div class="lg:col-span-3 space-y-1">
                <a href="#"
                    class="flex items-center gap-3 px-4 py-2 text-sm font-medium bg-white/10 text-white rounded-xl border border-white/5">
                    <i data-lucide="user" class="w-4 h-4 text-violet-400"></i> General
                </a>
                <a href="#"
                    class="flex items-center gap-3 px-4 py-2 text-sm font-medium text-gray-400 hover:bg-white/5 hover:text-white transition-all rounded-xl">
                    <i data-lucide="shield" class="w-4 h-4"></i> Security
                </a>
                <a href="#"
                    class="flex items-center gap-3 px-4 py-2 text-sm font-medium text-gray-400 hover:bg-white/5 hover:text-white transition-all rounded-xl">
                    <i data-lucide="zap" class="w-4 h-4"></i> Integrations
                </a>
            </div>

            <!-- Content -->
            <div class="lg:col-span-9 space-y-6">
                <!-- General Settings -->
                <div class="backdrop-blur-xl bg-white/5 border border-white/10 rounded-2xl p-6 shadow-xl">
                    <h3 class="text-lg font-semibold text-white mb-6">General Settings</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Repository Name</label>
                            <input type="text" id="agent-name" value="{{ agent.name if agent else '' }}"
                                class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-violet-500/50 transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Description</label>
                            <textarea rows="3" id="agent-description"
                                class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-violet-500/50 transition-all">{{ agent.description if agent else '' }}</textarea>
                        </div>
                        <div class="pt-4">
                            <button onclick="saveSettings()" id="save-btn"
                                class="px-6 py-2.5 bg-violet-600 hover:bg-violet-500 text-white font-medium rounded-xl shadow-lg shadow-violet-500/20 transition-all">Save
                                Changes</button>
                        </div>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="backdrop-blur-xl bg-red-500/5 border border-red-500/20 rounded-2xl p-6 shadow-xl">
                    <h3 class="text-lg font-semibold text-red-400 mb-6 flex items-center gap-2">
                        <i data-lucide="alert-triangle" class="w-5 h-5"></i> Danger Zone
                    </h3>
                    <div class="divide-y divide-red-500/10">
                        <div class="py-4 flex items-center justify-between">
                            <div>
                                <h4 class="text-sm font-semibold text-gray-200">Archive this repository</h4>
                                <p class="text-xs text-gray-500">Mark this repository as read-only.</p>
                            </div>
                            <button onclick="archiveRepo()"
                                class="px-4 py-2 border border-red-500/30 text-red-400 text-sm font-medium rounded-xl hover:bg-red-500/10 transition-all">Archive</button>
                        </div>
                        <div class="py-4 flex items-center justify-between">
                            <div>
                                <h4 class="text-sm font-semibold text-red-400">Delete this repository</h4>
                                <p class="text-xs text-gray-500">Permanently remove the repository and all its context.
                                </p>
                            </div>
                            <button onclick="deleteRepo()"
                                class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white text-sm font-medium rounded-xl shadow-lg shadow-red-500/20 transition-all">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const agentId = "{{ agent.id if agent else '' }}";

    async function saveSettings() {
        const btn = document.getElementById('save-btn');
        const name = document.getElementById('agent-name').value;
        const description = document.getElementById('agent-description').value;

        btn.disabled = true;
        btn.textContent = 'Saving...';

        try {
            const resp = await fetch(`/gitmem/api/agent/${agentId}/settings`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, description })
            });

            if (resp.ok) {
                btn.textContent = 'Saved!';
                btn.classList.add('bg-green-600');
                setTimeout(() => {
                    btn.textContent = 'Save Changes';
                    btn.classList.remove('bg-green-600');
                    btn.disabled = false;
                }, 2000);
            } else {
                throw new Error('Save failed');
            }
        } catch (e) {
            console.error('Save failed:', e);
            btn.textContent = 'Error!';
            btn.classList.add('bg-red-600');
            setTimeout(() => {
                btn.textContent = 'Save Changes';
                btn.classList.remove('bg-red-600');
                btn.disabled = false;
            }, 2000);
        }
    }

    async function archiveRepo() {
        if (!confirm('Are you sure you want to archive this repository? It will become read-only.')) return;

        try {
            const resp = await fetch(`/gitmem/api/agent/${agentId}/archive`, { method: 'POST' });
            if (resp.ok) {
                alert('Repository archived successfully.');
                window.location.reload();
            } else {
                alert('Failed to archive repository.');
            }
        } catch (e) {
            console.error('Archive failed:', e);
            alert('Archive operation failed.');
        }
    }

    async function deleteRepo() {
        if (!confirm('⚠️ WARNING: This will permanently delete all memories and context for this agent. This cannot be undone. Continue?')) return;
        if (!confirm('Are you absolutely sure? Type the agent name to confirm would be safer...')) return;

        try {
            const resp = await fetch(`/gitmem/api/agent/${agentId}`, { method: 'DELETE' });
            if (resp.ok) {
                alert('Repository deleted.');
                window.location.href = '/gitmem/';
            } else {
                alert('Failed to delete repository.');
            }
        } catch (e) {
            console.error('Delete failed:', e);
            alert('Delete operation failed.');
        }
    }
</script>
{% endblock %}