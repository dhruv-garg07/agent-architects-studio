{% extends "gitmem/base.html" %}

{% block title %}GitMem - Documents - {{ agent.name if agent else 'Agent' }}{% endblock %}

{% block repo_content %}
<div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
    <!-- Main Content -->
    <div class="lg:col-span-3 space-y-6">
        <!-- Page Header -->
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <a href="{{ url_for('gitmem.agent_dashboard', agent_id=agent.id if agent else '') }}"
                    class="text-muted-foreground hover:text-foreground">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                </a>
                <h2 class="text-xl font-semibold">Documents</h2>
                <span class="px-2 py-0.5 text-xs bg-secondary rounded-full">{{ documents|length }} files</span>
            </div>
            <button onclick="toggleUploadModal()" class="btn-primary flex items-center gap-2">
                <i data-lucide="upload" class="w-4 h-4"></i>
                Upload Document
            </button>
        </div>

        <!-- Folder Tabs -->
        <div class="flex gap-2 border-b border-border pb-2">
            {% for f in ['uploads', 'attachments', 'references'] %}
            <a href="?folder={{ f }}"
                class="px-4 py-2 rounded-t-lg text-sm font-medium transition-colors
                      {{ 'bg-primary/10 text-primary border-b-2 border-primary' if folder == f else 'text-muted-foreground hover:text-foreground hover:bg-secondary/50' }}">
                <i data-lucide="{{ 'upload' if f == 'uploads' else 'paperclip' if f == 'attachments' else 'book-open' }}"
                    class="w-4 h-4 inline-block mr-1"></i>
                {{ f|capitalize }}
            </a>
            {% endfor %}
        </div>

        <!-- Documents List -->
        <div class="gh-box">
            {% if documents %}
            <div class="divide-y divide-border">
                {% for doc in documents %}
                <div class="flex items-center justify-between p-4 hover:bg-secondary/30 transition-colors group">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
                            <i data-lucide="{{ 'file-text' if 'text' in (doc.content_type or '') else 'file' }}"
                                class="w-5 h-5 icon-file"></i>
                        </div>
                        <div>
                            <p class="font-medium">{{ doc.filename }}</p>
                            <p class="text-xs text-muted-foreground">
                                {{ (doc.size_bytes / 1024)|round(1) }} KB • {{ doc.content_type or 'unknown' }}
                                {% if doc.description %}
                                • {{ doc.description }}
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="viewDocument('{{ doc.id }}')" class="btn-secondary px-3 py-1.5 text-xs">
                            <i data-lucide="eye" class="w-3 h-3"></i>
                        </button>
                        <button onclick="deleteDocument('{{ doc.id }}')"
                            class="btn-secondary px-3 py-1.5 text-xs text-red-400 hover:text-red-300">
                            <i data-lucide="trash-2" class="w-3 h-3"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="p-12 text-center text-muted-foreground">
                <i data-lucide="folder-open" class="w-12 h-12 mx-auto mb-4 opacity-30"></i>
                <p class="text-lg mb-2">No documents in {{ folder }}</p>
                <p class="text-sm">Upload your first document to get started</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-4">
        <!-- Folder Info -->
        <div class="gh-box p-4">
            <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
                <i data-lucide="folder" class="w-4 h-4 text-primary"></i>
                Folder Info
            </h3>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-muted-foreground">Files</span>
                    <span class="font-medium">{{ documents|length }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-muted-foreground">Total Size</span>
                    <span class="font-medium">
                        {{ (documents|sum(attribute='size_bytes') / 1024)|round(1) if documents else 0 }} KB
                    </span>
                </div>
            </div>
        </div>

        <!-- Supported Formats -->
        <div class="gh-box p-4">
            <h3 class="text-sm font-semibold mb-3">Supported Formats</h3>
            <div class="flex flex-wrap gap-1">
                {% for fmt in ['PDF', 'TXT', 'MD', 'JSON', 'CSV', 'DOCX'] %}
                <span class="px-2 py-0.5 text-xs bg-secondary/50 rounded-full text-muted-foreground">
                    .{{ fmt|lower }}
                </span>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div id="upload-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="toggleUploadModal()"></div>
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-lg">
        <div class="gh-box p-6">
            <h3 class="text-lg font-semibold mb-4">Upload Document</h3>
            <form id="upload-form" enctype="multipart/form-data" class="space-y-4">
                <div>
                    <label class="text-sm font-medium text-muted-foreground">File</label>
                    <input type="file" name="file" class="w-full mt-1 p-2 bg-secondary border border-border rounded-lg">
                </div>
                <div>
                    <label class="text-sm font-medium text-muted-foreground">Folder</label>
                    <select name="folder" class="w-full mt-1 p-2 bg-secondary border border-border rounded-lg">
                        <option value="uploads">Uploads</option>
                        <option value="attachments">Attachments</option>
                        <option value="references">References</option>
                    </select>
                </div>
                <div>
                    <label class="text-sm font-medium text-muted-foreground">Description (optional)</label>
                    <input type="text" name="description"
                        class="w-full mt-1 p-2 bg-secondary border border-border rounded-lg">
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="toggleUploadModal()" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function toggleUploadModal() {
        const modal = document.getElementById('upload-modal');
        modal.classList.toggle('hidden');
    }

    document.getElementById('upload-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);

        try {
            const resp = await fetch('/gitmem/api/documents/{{ agent.id if agent else "" }}/upload', {
                method: 'POST',
                body: formData
            });
            const data = await resp.json();
            if (data.status === 'uploaded') {
                window.location.reload();
            } else {
                alert('Upload failed: ' + (data.error || 'Unknown error'));
            }
        } catch (err) {
            alert('Upload failed: ' + err.message);
        }
    });

    async function deleteDocument(docId) {
        if (!confirm('Are you sure you want to delete this document?')) return;

        try {
            const resp = await fetch(`/gitmem/api/documents/{{ agent.id if agent else "" }}/${docId}`, {
                method: 'DELETE'
            });
            const data = await resp.json();
            if (data.status === 'deleted') {
                window.location.reload();
            }
        } catch (err) {
            alert('Delete failed: ' + err.message);
        }
    }

    function viewDocument(docId) {
        // TODO: Implement document viewer modal
        alert('Document viewer coming soon!');
    }
</script>
{% endblock %}