{% extends "layouts/github_shell.html" %}
{% set active_page = "code" %}

{% block title %}View File - {{ path.split('/')[-1] }} | GitMem{% endblock %}

{% block repo_content %}
<div class="relative min-h-screen bg-transparent text-foreground overflow-hidden">
    <!-- Mesh Gradients Background (Updated to match API docs) -->
    <div class="absolute inset-0 pointer-events-none">
        <div class="absolute top-0 left-1/4 w-96 h-96 bg-[rgba(139,92,246,0.1)] rounded-full blur-3xl"></div>
        <div class="absolute bottom-0 right-1/4 w-80 h-80 bg-[rgba(6,182,212,0.1)] rounded-full blur-3xl"></div>
    </div>

    <!-- Main Container (Unwrapped to match file_browser structure) -->
    <div class="relative z-10">

        <!-- Control Bar (Matches file_browser.html) -->
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6 gap-4">
            {% set virtual_path = path %}
            {% include "components/file_navigation_pill.html" %}

            <div class="flex items-center gap-3">
                <button
                    class="px-4 py-2 rounded-xl bg-[rgba(255,255,255,0.05)] border border-[rgba(255,255,255,0.1)] text-xs text-gray-400 backdrop-blur-md flex items-center gap-2 hover:bg-[rgba(255,255,255,0.1)] hover:text-white transition-all">
                    <i data-lucide="history" class="w-4 h-4"></i>
                    <span>History</span>
                </button>
                <button
                    onclick="window.location.href=`{{ url_for('gitmem.agent_file_view', agent_id=agent.id, virtual_path=path, raw=1) }}`"
                    class="px-4 py-2 rounded-xl bg-[#238636] border border-[rgba(255,255,255,0.1)] text-xs font-bold text-white shadow-lg shadow-green-900/20 hover:bg-[#2ea043] transition-all flex items-center gap-2">
                    <i data-lucide="download" class="w-4 h-4"></i>
                    <span>Raw</span>
                </button>
            </div>
        </div>

        <!-- File Content Explorer -->
        <div
            class="backdrop-blur-xl bg-[rgba(255,255,255,0.02)] border border-[rgba(255,255,255,0.1)] rounded-2xl overflow-hidden shadow-2xl">
            <!-- Toolbar -->
            <div
                class="px-6 py-3 border-b border-[rgba(255,255,255,0.03)] bg-[rgba(255,255,255,0.05)] flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <div
                        class="flex items-center gap-3 px-3 py-1.5 rounded-lg bg-[rgba(0,0,0,0.2)] border border-[rgba(255,255,255,0.05)]">
                        <span class="text-[11px] font-mono text-gray-400">
                            {% set lines = content.splitlines() %}
                            <span class="text-gray-200">{{ lines|length }}</span> lines
                        </span>
                        <span class="w-px h-3 bg-[rgba(255,255,255,0.1)]"></span>
                        <span class="text-[11px] font-mono text-gray-400"><span class="text-gray-200">{{ (content|length
                                / 1024)|round(2) }}</span> KB</span>
                    </div>

                    {% if metadata.type %}
                    <span
                        class="px-2 py-0.5 rounded-full bg-[rgba(59,130,246,0.1)] border border-[rgba(59,130,246,0.2)] text-[10px] font-bold uppercase tracking-wider text-[#93c5fd]">
                        {{ metadata.type }}
                    </span>
                    {% endif %}
                </div>

                <div class="flex items-center gap-2">
                    <div class="flex bg-[rgba(0,0,0,0.2)] p-1 rounded-lg border border-[rgba(255,255,255,0.05)] mr-2">
                        <button
                            class="px-3 py-1 text-[10px] font-bold uppercase tracking-tight text-white bg-[rgba(255,255,255,0.1)] rounded-md">Code</button>
                        <button
                            class="px-3 py-1 text-[10px] font-bold uppercase tracking-tight text-gray-500 hover:text-gray-300">Preview</button>
                    </div>
                    <button
                        class="p-2 rounded-lg bg-[rgba(255,255,255,0.05)] border border-[rgba(255,255,255,0.05)] hover:border-[rgba(255,255,255,0.2)] text-gray-400 hover:text-white transition-all"
                        onclick="copyToClipboard(`{{ content|escape|replace('\n', '\\n')|replace('\'', '\\\'') }}`)"
                        title="Copy Content">
                        <i data-lucide="copy" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <!-- Code Viewer -->
            <div class="bg-[rgba(0,0,0,0.3)] overflow-x-auto min-h-[400px]">
                <table class="w-full border-collapse font-mono text-[13px] leading-relaxed">
                    <tbody>
                        {% for line in content.splitlines() %}
                        <tr class="group hover:bg-[rgba(255,255,255,0.02)]">
                            <td
                                class="w-12 select-none text-right pr-4 text-gray-600 border-r border-[rgba(255,255,255,0.05)] bg-[rgba(0,0,0,0.1)] sticky left-0 group-hover:text-gray-400 transition-colors py-0.5">
                                {{ loop.index }}
                            </td>
                            <td
                                class="pl-4 pr-6 whitespace-pre text-gray-300 py-0.5 selection:bg-[rgba(59,130,246,0.3)]">
                                {{- line -}}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Metadata & Insights -->
        <div class="mt-12">
            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-[0.2em] mb-6 flex items-center gap-2">
                <i data-lucide="database" class="w-4 h-4"></i> Node Properties
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                {% for key, value in metadata.items() %}
                <div
                    class="backdrop-blur-md bg-[rgba(255,255,255,0.05)] border border-[rgba(255,255,255,0.05)] rounded-xl p-5 hover:border-[rgba(59,130,246,0.3)] transition-all group">
                    <div
                        class="text-[10px] uppercase text-gray-500 font-bold tracking-widest mb-2 group-hover:text-[#93c5fd] transition-colors">
                        {{ key }}
                    </div>
                    <div class="text-sm text-gray-300 font-mono break-all line-clamp-2" title="{{ value }}">
                        {{ value }}
                    </div>
                </div>
                {% endfor %}

                <!-- Cloud Sync Badge -->
                <div
                    class="backdrop-blur-md bg-[rgba(59,130,246,0.05)] border border-[rgba(59,130,246,0.1)] rounded-xl p-5 flex flex-col justify-between">
                    <div>
                        <div class="text-[10px] uppercase text-[#93c5fd]/70 font-bold tracking-widest mb-2">Sync Status
                        </div>
                        <div class="text-xs text-gray-300 font-medium">Verified in Vector Index</div>
                    </div>
                    <div
                        class="mt-4 flex items-center gap-2 text-[10px] text-[#34d399] font-bold uppercase tracking-widest">
                        <span
                            class="w-1.5 h-1.5 rounded-full bg-[#10b981] shadow-[0_0_8px_rgba(16,185,129,0.5)]"></span>
                        Live
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            // Success feedback could be added here via base.html's showNotification if available
            console.log('Copied to clipboard');
        });
    }
</script>
{% endblock %}