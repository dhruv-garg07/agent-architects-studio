{% extends "layouts/github_shell.html" %}

{% block content %}
<!-- Wrapper to maintain block name compatibility -->
{% block repo_content %}{% endblock %}
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Star Button Handler (If present in children)
        const starBtn = document.getElementById('star-btn');
        if (starBtn) {
            starBtn.addEventListener('click', async () => {
                try {
                    const resp = await fetch('/gitmem/api/star', { method: 'POST' });
                    const data = await resp.json();
                    if (data.status === 'starred') {
                        const countSpan = starBtn.querySelector('span');
                        countSpan.textContent = data.count;
                        starBtn.classList.toggle('text-yellow-500');
                        starBtn.querySelector('i').classList.toggle('fill-current');
                    }
                } catch (e) { console.error('Star failed', e); }
            });
        }

        // Fork Button Handler
        const forkBtn = document.getElementById('fork-btn');
        if (forkBtn) {
            forkBtn.addEventListener('click', async () => {
                alert('Forking memory repository... (This is a demo action)');
            });
        }

        // ============================================
        // WebSocket Real-Time Updates
        // ============================================

        // Initialize Socket.IO connection
        let socket = null;
        try {
            socket = io('/gitmem', {
                transports: ['websocket'],
                reconnection: true,
                reconnectionDelay: 5000,
                reconnectionAttempts: 5
            });
        } catch (e) {
            console.log('[GitMem] WebSocket not available, falling back to polling');
        }

        if (socket) {
            // Connection events
            socket.on('connect', () => {
                console.log('[GitMem] ðŸ”Œ Connected to real-time updates');
                updateConnectionStatus(true);
                // Stats are already loaded with the page - no need to request again
                // Only request stats refresh if explicitly triggered by user action
            });

            socket.on('disconnect', () => {
                console.log('[GitMem] âŒ Disconnected from real-time updates');
                updateConnectionStatus(false);
            });

            socket.on('connection_established', (data) => {
                console.log('[GitMem] Session established:', data.client_id);
            });

            // Real-time event handlers
            socket.on('gitmem_event', (event) => {
                console.log('[GitMem] ðŸ“¡ Event received:', event.type, event);
                handleRealtimeEvent(event);
            });

            socket.on('stats_update', (stats) => {
                console.log('[GitMem] ðŸ“Š Stats update:', stats);
                updateDashboardStats(stats);
            });

            socket.on('activity_feed', (data) => {
                console.log('[GitMem] ðŸ“‹ Activity feed update');
                updateActivityFeed(data.items);
            });
        }

        // Connection status indicator
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('ws-status');
            if (indicator) {
                indicator.className = connected
                    ? 'w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)] animate-pulse'
                    : 'w-2 h-2 rounded-full bg-red-500';
                indicator.title = connected ? 'Real-time updates active' : 'Disconnected';
            }
        }

        // Handle real-time events from the event bus
        function handleRealtimeEvent(event) {
            switch (event.type) {
                case 'agent:heartbeat':
                    updateAgentCount();
                    showNotification(`Agent ${event.agent_id} is online`, 'success');
                    break;
                // ... (Other handlers preserved logically)
            }
        }

        // ... (Preserving specific update functions if needed by child pages, 
        // usually these look for IDs. The new layout has new IDs or removed them.
        // I will keep the functions to prevent ReferenceErrors if called)

        function showNotification(message, type = 'info') {
            const container = document.getElementById('toast-container') || createToastContainer();
            const toast = document.createElement('div');
            toast.className = `
                px-4 py-3 rounded-lg shadow-xl border backdrop-blur-md bg-panel/90 border-border 
                animate-slideIn flex items-center gap-2 text-sm text-gray-200
            `;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'fixed bottom-4 right-4 z-50 flex flex-col gap-2';
            document.body.appendChild(container);
            return container;
        }
    });
</script>
{% endblock %}