{% extends "base.html" %}

{% block title %}Sign In - AI Agent Marketplace{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full">
        <div class="card p-8">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-foreground mb-2">Welcome Back</h1>
                <p class="text-muted-foreground">Sign in to access the AI Agent Marketplace</p>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-border mb-6">
                <button id="signin-tab"
                    class="flex-1 py-2 px-4 text-center font-medium border-b-2 border-primary text-primary"
                    onclick="switchTab('signin')">
                    Sign In
                </button>
                <button id="signup-tab"
                    class="flex-1 py-2 px-4 text-center font-medium border-b-2 border-transparent text-muted-foreground hover:text-foreground"
                    onclick="switchTab('signup')">
                    Sign Up
                </button>
            </div>

            <!-- Sign In Form -->
            <div id="signin-form">
                <form method="POST" action="{{ url_for('login') }}" class="space-y-4">
                    <div>
                        <label for="signin-email" class="block text-sm font-medium text-foreground mb-2">
                            Email Address
                        </label>
                        <input type="email" id="signin-email" name="email" required placeholder="Enter your email"
                            class="input w-full">
                    </div>

                    <div>
                        <label for="signin-password" class="block text-sm font-medium text-foreground mb-2">
                            Password
                        </label>
                        <input type="password" id="signin-password" name="password" required
                            placeholder="Enter your password" class="input w-full">
                    </div>

                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <input type="checkbox" id="remember" name="remember" class="mr-2">
                            <label for="remember" class="text-sm text-muted-foreground">
                                Remember me
                            </label>
                        </div>
                        <a href="#" class="text-sm text-primary hover:underline">
                            Forgot password?
                        </a>
                    </div>

                    <button type="submit" class="btn-primary w-full">
                        <i data-lucide="log-in" class="w-4 h-4 mr-2"></i>
                        Sign In
                    </button>
                </form>
            </div>

            <!-- Sign Up Form -->
            <div id="signup-form" class="hidden">
                <form method="POST" action="{{ url_for('register') }}" class="space-y-4">
                    <div>
                        <label for="signup-email" class="block text-sm font-medium text-foreground mb-2">
                            Email Address
                        </label>
                        <input type="email" id="signup-email" name="email" required placeholder="Enter your email"
                            class="input w-full">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div>
                            <label for="full-name" class="block text-sm font-medium text-foreground mb-2">
                                Full Name
                            </label>
                            <input type="text" id="full-name" name="full_name" required placeholder="e.g., Ada Lovelace"
                                class="input w-full">
                        </div>
                        <div>
                            <label for="username" class="block text-sm font-medium text-foreground mb-2">
                                Username
                            </label>
                            <input type="text" id="username" name="username" required placeholder="username"
                                class="input w-full">
                        </div>
                    </div>

                    <div class="mt-4">
                        <label for="signup-password" class="block text-sm font-medium text-foreground mb-2">
                            Password
                        </label>
                        <input type="password" id="signup-password" name="password" required
                            placeholder="Create a password" class="input w-full">
                        <p class="text-xs text-muted-foreground mt-1">
                            Must be at least 8 characters long.
                        </p>
                    </div>

                    <div class="mt-4">
                        <label for="confirm-password" class="block text-sm font-medium text-foreground mb-2">
                            Confirm Password
                        </label>
                        <input type="password" id="confirm-password" name="confirm_password" required
                            placeholder="Confirm your password" class="input w-full">
                    </div>

                    <hr class="my-6">

                    <div>
                        <label for="user-role" class="block text-sm font-medium text-foreground mb-2">
                            How will you be using our platform?
                        </label>
                        <select id="user-role" name="user_role" class="input w-full" required>
                            <option value="" disabled selected>Select an option...</option>
                            <option value="creator">I am a Creator (I want to submit AI agents)</option>
                            <option value="user">I am a User (I want to use AI agents)</option>
                        </select>
                    </div>

                    <div id="creator-fields" class="hidden space-y-4 mt-4">
                        <div>
                            <label for="portfolio-url" class="block text-sm font-medium text-foreground mb-2">
                                Portfolio or GitHub URL
                            </label>
                            <input type="url" id="portfolio-url" name="portfolio_url"
                                placeholder="https://github.com/your-username" class="input w-full">
                        </div>
                        <div>
                            <label for="expertise" class="block text-sm font-medium text-foreground mb-2">
                                Areas of Expertise
                            </label>
                            <input type="text" id="expertise" name="expertise"
                                placeholder="e.g., NLP, Computer Vision, Generative AI" class="input w-full">
                            <p class="text-xs text-muted-foreground mt-1">
                                Separate different areas with a comma.
                            </p>
                        </div>
                    </div>

                    <div id="user-fields" class="hidden mt-4">
                        <label for="primary-interest" class="block text-sm font-medium text-foreground mb-2">
                            What is your primary interest?
                        </label>
                        <select id="primary-interest" name="primary_interest" class="input w-full">
                            <option value="" disabled selected>Select your primary goal...</option>
                            <option value="business">For my business or work</option>
                            <option value="personal">For personal projects</option>
                            <option value="research">For academic research</option>
                            <option value="browsing">Just browsing</option>
                        </select>
                    </div>

                    <div class="flex items-start">
                        <input type="checkbox" id="terms-signup" name="terms" required class="mr-2 mt-1">
                        <label for="terms-signup" class="text-sm text-muted-foreground">
                            I agree to the <a href="#" class="text-primary hover:underline">Terms of Service</a>
                            and <a href="#" class="text-primary hover:underline">Privacy Policy</a>
                        </label>
                    </div>

                    <button type="submit" class="btn-primary w-full">
                        <i data-lucide="user-plus" class="w-4 h-4 mr-2"></i>
                        Create Account
                    </button>
                </form>
            </div>

            <!-- Divider -->
            <div class="relative my-6">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-border"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-card text-muted-foreground">Or continue with</span>
                </div>
            </div>

            <!-- Social Login -->
            <div class="space-y-3">
                <button id="github-login" class="btn-secondary w-full flex items-center justify-center">
                    <i data-lucide="github" class="w-4 h-4 mr-2"></i>
                    Continue with GitHub
                </button>

                <a href="{{ url_for('login_google') }}">
                    <button id="google-login" class="btn-secondary w-full flex items-center justify-center">
                        Continue with Google
                    </button>
                </a>

            </div>

        </div>

        <!-- Additional Info -->
        <div class="text-center mt-6 text-sm text-muted-foreground">
            <p>By signing in, you agree to our terms and privacy policy.</p>
        </div>
    </div>
</div>

<script>
    function switchTab(tabName) {
        const signinTab = document.getElementById('signin-tab');
        const signupTab = document.getElementById('signup-tab');
        const signinForm = document.getElementById('signin-form');
        const signupForm = document.getElementById('signup-form');

        if (tabName === 'signin') {
            signinTab.className = 'flex-1 py-2 px-4 text-center font-medium border-b-2 border-primary text-primary';
            signupTab.className = 'flex-1 py-2 px-4 text-center font-medium border-b-2 border-transparent text-muted-foreground hover:text-foreground';
            signinForm.classList.remove('hidden');
            signupForm.classList.add('hidden');
        } else {
            signupTab.className = 'flex-1 py-2 px-4 text-center font-medium border-b-2 border-primary text-primary';
            signinTab.className = 'flex-1 py-2 px-4 text-center font-medium border-b-2 border-transparent text-muted-foreground hover:text-foreground';
            signupForm.classList.remove('hidden');
            signinForm.classList.add('hidden');
        }
    }
</script>

<script>
    // Wait for the DOM to be fully loaded before running the script
    document.addEventListener('DOMContentLoaded', (event) => {

        // Find the elements in the document
        const userRoleSelect = document.getElementById('user-role');
        const creatorFields = document.getElementById('creator-fields');
        const userFields = document.getElementById('user-fields');

        // Add an event listener to the dropdown
        userRoleSelect.addEventListener('change', function () {
            // Check the selected value
            if (this.value === 'creator') {
                creatorFields.classList.remove('hidden');
                userFields.classList.add('hidden');
            } else if (this.value === 'user') {
                userFields.classList.remove('hidden');
                creatorFields.classList.add('hidden');
            } else {
                // Hide both if no option is selected
                creatorFields.classList.add('hidden');
                userFields.classList.add('hidden');
            }
        });

    });
</script>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

// Supabase client (ensure these render correctly from Flask)
const supabase = createClient(
    "{{ SUPABASE_URL }}",
    "{{ SUPABASE_ANON_KEY }}"
);

document.addEventListener('DOMContentLoaded', () => {

    // Google login
    const googleBtn = document.getElementById('google-login');
    if (googleBtn) {
        googleBtn.addEventListener('click', async () => {
            console.log("Google login button clicked");
            const { data, error } = await supabase.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: window.location.origin + "/auth/callback"
                }
            });
            if (error) console.error("Google login failed:", error.message);
            else if (data?.url) window.location.href = data.url;
        });
    }

    // GitHub login
    const githubBtn = document.getElementById('github-login');
    if (githubBtn) {
        githubBtn.addEventListener('click', async () => {
            console.log("GitHub login button clicked");
            const { data, error } = await supabase.auth.signInWithOAuth({
                provider: 'github',
                options: {
                    redirectTo: window.location.origin + "/auth/github/callback"
                }
            });
            if (error) console.error("GitHub login failed:", error.message);
            else if (data?.url) window.location.href = data.url;
        });
    }

    // Handle OAuth callback for Google
    if (window.location.pathname === "/auth/callback") {
        const fragment = new URLSearchParams(window.location.hash.slice(1));
        const access_token = fragment.get("access_token");
        const refresh_token = fragment.get("refresh_token");

        if (access_token) {
            fetch("/auth/callback", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ access_token, refresh_token })
            }).then(() => window.location.href = "/");
        }
    }

    // Handle OAuth callback for GitHub
    if (window.location.pathname === "/auth/github/callback") {
        const fragment = new URLSearchParams(window.location.hash.slice(1));
        const access_token = fragment.get("access_token");
        const refresh_token = fragment.get("refresh_token");

        if (access_token) {
            fetch("/auth/github/callback", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ access_token, refresh_token })
            }).then(() => window.location.href = "/");
        }
    }

});
</script>


<script>
    if (window.location.pathname === "/auth/callback") {
        const fragment = new URLSearchParams(window.location.hash.slice(1));
        const access_token = fragment.get("access_token");
        const refresh_token = fragment.get("refresh_token");

        if (access_token) {
            fetch("/auth/callback", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ access_token, refresh_token })
            }).then(() => {
                window.location.href = "/"; // or homepage
            });
        }
    }
</script>



{% endblock %}