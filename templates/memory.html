{% extends "base.html" %}

{% block title %}Memory Dashboard | AI Agent Marketplace{% endblock %}

{% block content %}
<div class="memory-dashboard min-h-screen bg-background text-foreground flex flex-col">
    <!-- Top Navigation Bar -->
    <header class="bg-card border-b border-border py-4 px-6 flex justify-between items-center">
        <div class="flex items-center space-x-3">
            <i data-lucide="brain" class="h-7 w-7 text-primary"></i>
            <h1 class="text-xl font-semibold">Memory Dashboard</h1>
        </div>
        <div class="flex items-center space-x-4">
            <!-- Session Management -->
            <div id="sessionControls" class="flex items-center space-x-3">
                <!-- New Session Button (shown when no sessions exist) -->
                <button id="newSessionBtn" class="btn-primary flex items-center space-x-2 hidden">
                    <i data-lucide="plus" class="h-4 w-4"></i>
                    <span>New Session</span>
                </button>
                <!-- Session Selector (shown when sessions exist) -->
                <div id="sessionSelector" class="hidden">
                    <select id="sessionDropdown" class="input bg-card border-border">
                        <option value="">Select Session</option>
                    </select>
                </div>
            </div>
            
            <!-- Add Data Button -->
            <button id="addDataBtn" class="btn-primary flex items-center space-x-2">
                <i data-lucide="plus" class="h-4 w-4"></i>
                <span>Add Data</span>
            </button>
            
            <!-- User Profile/Notifications -->
            <div class="flex items-center space-x-3">
                <button class="p-2 rounded-full hover:bg-secondary transition-colors">
                    <i data-lucide="bell" class="h-5 w-5"></i>
                </button>
                <div class="w-9 h-9 rounded-full bg-primary flex items-center justify-center text-primary-foreground font-medium shadow-md">
                    U
                </div>
            </div>
        </div>
    </header>

    <!-- Main Dashboard Content -->
    <div class="flex flex-1 overflow-hidden">
        <!-- Left Panel - Memory Sources & Sessions -->
        <div class="w-80 bg-card border-r border-border flex flex-col">
            <div class="p-5">
                <h2 class="text-sm font-medium text-muted-foreground uppercase tracking-wider mb-3">Memory Sources</h2>
                <nav class="space-y-1">
                    <a href="#" class="nav-item active flex items-center space-x-3 py-2 px-3 rounded-lg" data-section="sessions">
                        <i data-lucide="message-square" class="h-5 w-5"></i>
                        <span>Chat Sessions</span>
                    </a>
                    <a href="#" class="nav-item flex items-center space-x-3 py-2 px-3 rounded-lg" data-section="manual">
                        <i data-lucide="file-text" class="h-5 w-5"></i>
                        <span>Manual Data</span>
                    </a>
                    <a href="#" class="nav-item flex items-center space-x-3 py-2 px-3 rounded-lg" data-section="integrations">
                        <i data-lucide="link" class="h-5 w-5"></i>
                        <span>External Integrations</span>
                    </a>
                </nav>
            </div>
            
            <!-- Sessions Panel -->
            <div id="sessionsPanel" class="flex-1 overflow-y-auto p-5 border-t border-border">
                <div id="noSessionsMessage" class="text-center py-8">
                    <i data-lucide="message-square" class="h-12 w-12 text-muted-foreground mx-auto mb-3"></i>
                    <p class="text-muted-foreground">No chat sessions yet</p>
                    <p class="text-sm text-muted-foreground mt-1">Start a new conversation to create your first session</p>
                </div>
                
                <div id="sessionsList" class="space-y-3 hidden">
                    <!-- Sessions will be dynamically populated here -->
                </div>
            </div>
            
            <div class="p-5 border-t border-border">
                <h2 class="text-sm font-medium text-muted-foreground uppercase tracking-wider mb-3">Memory Settings</h2>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm">Auto-sync</span>
                        <label class="switch">
                            <input type="checkbox" checked>
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm">Privacy Mode</span>
                        <label class="switch">
                            <input type="checkbox">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Center Panel - AI Response & Conversation -->
        <div class="flex-1 bg-background border-r border-border flex flex-col">
            <div class="p-5 border-b border-border">
                <h2 class="text-lg font-semibold">AI Assistant</h2>
                <p class="text-sm text-muted-foreground mt-1" id="conversationContext">Ask questions about your memory data</p>
            </div>
            
            <!-- Conversation History -->
            <div id="conversationHistory" class="flex-1 overflow-y-auto p-5 space-y-6">
                <div class="text-center py-12 text-muted-foreground" id="emptyConversation">
                    <i data-lucide="message-square" class="h-16 w-16 mx-auto mb-4 opacity-50"></i>
                    <p class="text-lg">No conversation yet</p>
                    <p class="text-sm mt-1">Start by asking a question about your memory data</p>
                </div>
                
                <!-- Conversation messages will be dynamically added here -->
            </div>
            
            <!-- Chat Input -->
            <div class="p-5 border-t border-border bg-card">
                <form id="chatForm" class="flex items-center space-x-3">
                    <div class="flex-1 relative">
                        <input type="text" id="chatInput" placeholder="Query your memory..." class="input w-full pr-12" autocomplete="off">
                        <button type="button" id="attachFileBtn" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-muted-foreground hover:text-foreground transition-colors">
                            <i data-lucide="paperclip" class="h-5 w-5"></i>
                        </button>
                    </div>
                    <button type="submit" class="btn-primary p-3 rounded-lg">
                        <i data-lucide="send" class="h-5 w-5"></i>
                    </button>
                </form>
            </div>
        </div>

        <!-- Right Panel - RAG Results -->
        <div class="w-96 bg-card flex flex-col">
            <div class="p-5 border-b border-border flex justify-between items-center">
                <h2 class="text-lg font-semibold">RAG Results</h2>
                <div class="flex space-x-2">
                    <button id="exportResultsBtn" class="btn-secondary text-sm py-1 px-2 flex items-center" title="Export Results">
                        <i data-lucide="download" class="h-4 w-4"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-5 space-y-4" id="ragResults">
                <div class="text-center py-12 text-muted-foreground" id="emptyRagResults">
                    <i data-lucide="search" class="h-16 w-16 mx-auto mb-4 opacity-50"></i>
                    <p class="text-lg">No results yet</p>
                    <p class="text-sm mt-1">Ask a question to see relevant memory matches</p>
                </div>
                
                <!-- RAG result blocks will be dynamically added here -->
            </div>
        </div>
    </div>
</div>

<!-- Add Data Modal -->
<div id="addDataModal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm" id="modalBackdrop"></div>
    <div class="relative bg-card rounded-xl border border-border shadow-2xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-card border-b border-border p-6 rounded-t-xl flex justify-between items-center">
            <h2 class="text-xl font-semibold">Add New Memory</h2>
            <button id="closeModal" class="text-muted-foreground hover:text-foreground transition-colors p-1 rounded-full hover:bg-secondary">
                <i data-lucide="x" class="h-6 w-6"></i>
            </button>
        </div>
        
        <form method="POST" enctype="multipart/form-data" class="space-y-6 p-6">
            <div>
                <label for="memory_text" class="block font-medium mb-2">Text Input</label>
                <textarea id="memory_text" name="memory_text" rows="4" class="input w-full" placeholder="Add your memory text..."></textarea>
            </div>
            
            <div>
                <label for="memory_file" class="block font-medium mb-2">Upload Document</label>
                <div class="border-2 border-dashed border-border rounded-lg p-6 text-center hover:border-primary/50 transition-colors cursor-pointer" id="dropZone">
                    <i data-lucide="upload-cloud" class="h-12 w-12 text-muted-foreground mx-auto"></i>
                    <p class="mt-2 text-sm text-muted-foreground">Drag and drop your file here, or click to browse</p>
                    <input type="file" id="memory_file" name="memory_file" class="hidden" multiple accept=".pdf,.ppt,.pptx,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif,.bmp,.svg,.webp,.heic,.tiff,.xls,.xlsx,.csv" />
                    <button type="button" id="fileUploadBtn" class="btn-secondary mt-3">Select File</button>
                </div>
                <p class="text-xs text-muted-foreground mt-2">Supported formats: PDF, PPT, DOC, TXT, JPG, PNG, GIF (Max 25MB per file)</p>
                
                <!-- File preview container -->
                <div id="filePreview" class="mt-4 hidden">
                    <div class="flex items-center justify-between p-3 bg-secondary/30 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <i data-lucide="file-text" class="h-5 w-5 text-primary"></i>
                            <div>
                                <p id="fileName" class="text-sm font-medium"></p>
                                <p id="fileSize" class="text-xs text-muted-foreground"></p>
                            </div>
                        </div>
                        <button type="button" id="removeFileBtn" class="text-muted-foreground hover:text-destructive transition-colors p-1">
                            <i data-lucide="trash-2" class="h-4 w-4"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Error message container -->
                <div id="fileError" class="mt-2 text-xs text-destructive hidden"></div>
            </div>
            
            <div>
                <label for="memory_tags" class="block font-medium mb-2">Tags</label>
                <input type="text" id="memory_tags" name="memory_tags" class="input w-full" placeholder="Add tags (comma separated)" />
            </div>
            
            <div class="flex justify-end space-x-3 pt-4 border-t border-border">
                <button type="button" id="cancelModal" class="btn-secondary">Cancel</button>
                <button type="submit" class="btn-primary">Save Memory</button>
            </div>
        </form>
    </div>
</div>

<style>
    /* Memory Dashboard Specific Styles */
    .memory-dashboard {
        /* Using the same variables as base.html */
    }

    .memory-dashboard .nav-item {
        display: flex;
        align-items: center;
        color: hsl(var(--muted-foreground));
        transition: all 0.2s ease;
    }

    .memory-dashboard .nav-item:hover {
        background-color: hsl(var(--secondary));
        color: hsl(var(--foreground));
    }

    .memory-dashboard .nav-item.active {
        background-color: hsl(var(--primary));
        color: hsl(var(--primary-foreground));
    }

    /* RAG Result Block Styling */
    .rag-result {
        background: hsl(var(--card));
        border: 1px solid hsl(var(--border));
        border-radius: 8px;
        padding: 1rem;
        transition: all 0.2s ease;
    }

    .rag-result:hover {
        border-color: hsl(var(--primary));
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .rag-result.selected {
        border-color: hsl(var(--primary));
        background: hsl(var(--primary)/0.05);
    }

    .rag-score {
        display: inline-flex;
        align-items: center;
        background: hsl(var(--primary));
        color: hsl(var(--primary-foreground));
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .rag-text-match {
        background: hsl(var(--primary)/0.2);
        padding: 0.1rem 0.25rem;
        border-radius: 2px;
        font-weight: 500;
    }

    .rag-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.75rem;
        color: hsl(var(--muted-foreground));
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid hsl(var(--border)/0.5);
    }

    .rag-feedback {
        display: flex;
        gap: 0.5rem;
    }

    .feedback-btn {
        background: transparent;
        border: 1px solid hsl(var(--border));
        border-radius: 4px;
        padding: 0.25rem 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .feedback-btn:hover {
        background: hsl(var(--secondary));
    }

    .feedback-btn.active {
        background: hsl(var(--primary));
        color: hsl(var(--primary-foreground));
        border-color: hsl(var(--primary));
    }

    /* Conversation Message Styling */
    .message {
        display: flex;
        margin-bottom: 1.5rem;
    }

    .message.user {
        justify-content: flex-end;
    }

    .message.assistant {
        justify-content: flex-start;
    }

    .message-content {
        max-width: 80%;
        padding: 1rem;
        border-radius: 12px;
        position: relative;
    }

    .message.user .message-content {
        background: hsl(var(--primary));
        color: hsl(var(--primary-foreground));
        border-bottom-right-radius: 4px;
    }

    .message.assistant .message-content {
        background: hsl(var(--secondary));
        border-bottom-left-radius: 4px;
    }

    .message-time {
        font-size: 0.75rem;
        color: hsl(var(--muted-foreground));
        margin-top: 0.5rem;
        text-align: right;
    }

    .message.assistant .message-time {
        text-align: left;
    }

    /* Session List Styling */
    .session-item {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid transparent;
    }

    .session-item:hover {
        background: hsl(var(--secondary));
    }

    .session-item.active {
        background: hsl(var(--primary)/0.1);
        border-color: hsl(var(--primary));
    }

    .session-preview {
        font-size: 0.875rem;
        color: hsl(var(--muted-foreground));
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Switch Styling */
    .switch {
        position: relative;
        display: inline-block;
        width: 40px;
        height: 22px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: hsl(var(--muted));
        transition: .4s;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
    }

    input:checked + .slider {
        background-color: hsl(var(--primary));
    }

    input:checked + .slider:before {
        transform: translateX(18px);
    }

    .slider.round {
        border-radius: 34px;
    }

    .slider.round:before {
        border-radius: 50%;
    }

    /* Modal styles */
    #addDataModal {
        transition: opacity 0.2s ease;
    }

    #addDataModal:not(.hidden) {
        display: flex;
        opacity: 1;
    }

    /* File preview styles */
    #filePreview {
        transition: all 0.3s ease;
    }

    /* Responsive adjustments */
    @media (max-width: 1024px) {
        .memory-dashboard .w-80 {
            width: 250px;
        }
        .memory-dashboard .w-96 {
            width: 300px;
        }
    }

    @media (max-width: 768px) {
        .memory-dashboard .flex {
            flex-direction: column;
        }
        .memory-dashboard .w-80,
        .memory-dashboard .w-96 {
            width: 100%;
        }
        .memory-dashboard .border-r {
            border-right: none;
            border-bottom: 1px solid hsl(var(--border));
        }
        
        .message-content {
            max-width: 90%;
        }
    }
</style>
<!-- memory.html -->
<script>
    // expose the logged-in user's id to JS
    window.USER_ID = "{{ current_user.id }}";
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Lucide icons
        lucide.createIcons();
        
        // State management
        let currentSession = null;
        let sessions = [];
        let ragResults = [];
        let currentSendToken = 0;

        // DOM Elements
        const modal = document.getElementById('addDataModal');
        const modalBackdrop = document.getElementById('modalBackdrop');
        const addBtn = document.getElementById('addDataBtn');
        const closeBtn = document.getElementById('closeModal');
        const cancelBtn = document.getElementById('cancelModal');
        const fileUploadBtn = document.getElementById('fileUploadBtn');
        const fileInput = document.getElementById('memory_file');
        const dropZone = document.getElementById('dropZone');
        const filePreview = document.getElementById('filePreview');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const removeFileBtn = document.getElementById('removeFileBtn');
        const fileError = document.getElementById('fileError');
        const chatForm = document.getElementById('chatForm');
        const chatInput = document.getElementById('chatInput');
        const conversationHistory = document.getElementById('conversationHistory');
        const emptyConversation = document.getElementById('emptyConversation');
        const ragResultsContainer = document.getElementById('ragResults');
        const emptyRagResults = document.getElementById('emptyRagResults');
        const sessionsPanel = document.getElementById('sessionsPanel');
        const sessionsList = document.getElementById('sessionsList');
        const noSessionsMessage = document.getElementById('noSessionsMessage');
        const newSessionBtn = document.getElementById('newSessionBtn');
        const sessionSelector = document.getElementById('sessionSelector');
        const sessionDropdown = document.getElementById('sessionDropdown');
        const navItems = document.querySelectorAll('.nav-item');
        const exportResultsBtn = document.getElementById('exportResultsBtn');
        
        // Initialize the dashboard
        initDashboard();
        
        async function initDashboard() {
            await refreshSessionsFromServer();
            updateSessionUI();
            if (sessions.length > 0) {
                await loadSession(sessions[0].id); // newest first
            } else {
                renderConversation([]); // empty state
            }
        }



        function updateSessionUI() {
        newSessionBtn.classList.remove('hidden');      // <-- always visible
        sessionSelector.classList.toggle('hidden', sessions.length === 0);
        sessionsList.classList.toggle('hidden', sessions.length === 0);
        noSessionsMessage.classList.toggle('hidden', sessions.length !== 0);
        updateSessionDropdown();
        renderSessionsList();
        }

        
        function updateSessionDropdown() {
        sessionDropdown.innerHTML = '<option value="">Select Session</option>';
        sessions.forEach(s => {
            const option = document.createElement('option');
            option.value = s.id;
            option.textContent = `Session ${s.id.slice(0,8)}… — ${new Date(s.createdAt).toLocaleDateString()}`;
            sessionDropdown.appendChild(option);
        });
        if (currentSession) sessionDropdown.value = currentSession.id;
        }

        function renderSessionsList() {
        sessionsList.innerHTML = '';
        sessions.forEach(s => {
            const el = document.createElement('div');
            el.className = `session-item ${currentSession && currentSession.id === s.id ? 'active' : ''}`;
            el.innerHTML = `
            <div class="flex-1 min-w-0">
                <div class="font-medium">Session ${s.id.slice(0,8)}…</div>
                <div class="session-preview">${(s.preview || 'No messages').substring(0,50)}...</div>
            </div>
            <div class="text-xs text-muted-foreground">${new Date(s.updatedAt).toLocaleTimeString()}</div>
            `;
            el.addEventListener('click', () => loadSession(s.id));
            sessionsList.appendChild(el);
        });
        }

        sessionDropdown.addEventListener('change', function() {
        if (this.value) loadSession(this.value);
        });
        newSessionBtn.addEventListener('click', createNewSession);


        // New function
        async function refreshSessionsFromServer() {
            const res = await fetch(`/api/get_sessions?id={{ current_user.id }}`);
            const ids = await res.json();  // ["uuid1","uuid2",...]

            if (!Array.isArray(ids)) { sessions = []; return; }

            const enriched = await Promise.all(ids.map(async (thread_id) => {
                try {
                const r = await fetch(`/api/sessions/${thread_id}/messages?id=${encodeURIComponent(window.USER_ID)}`);
                const { messages = [] } = await r.json();

                const last = messages.slice().sort((a, b) => {
                    const ta = (a.metadata?.timestamp ?? 0), tb = (b.metadata?.timestamp ?? 0);
                    if (tb !== ta) return tb - ta;
                    const ia = (a.metadata?.index ?? 0), ib = (b.metadata?.index ?? 0);
                    return ib - ia;
                })[0];

                const iso = last?.metadata?.timestamp
                    ? new Date(last.metadata.timestamp * 1000).toISOString()
                    : new Date().toISOString();

                return {
                    id: thread_id,
                    createdAt: iso,
                    updatedAt: iso,
                    preview: last?.document || 'No messages'
                };
                } catch {
                return {
                    id: thread_id,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    preview: 'No messages'
                };
                }
            }));

            enriched.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
            sessions = enriched;
        }


        
        async function createNewSession() {
            const res = await fetch('/api/create_session', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    user_id: '{{current_user.id}}',
                })
            });
            const { thread_id, createdAt } = await res.json();

            // Put new session at the top
            const newSession = {
                id: thread_id,                // UUID from backend
                createdAt: createdAt || new Date().toISOString(),
                updatedAt: createdAt || new Date().toISOString(),
                messages: []
            };


        sessions.unshift(newSession);
        currentSession = newSession;

        updateSessionUI();
        // Clear the chat area immediately (nice UX) then load from server (will be empty)
        renderConversation([]);
        await loadSession(newSession.id);
        }

        let currentLoadToken = 0;

        async function loadSession(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            const myToken = ++currentLoadToken;       // capture token for this load
            currentSession = session;
            renderConversation([]);           // clear immediately for better UX    
            clearRAGResults();

            const res = await fetch(`/api/sessions/${currentSession.id}/messages?id={{ current_user.id }}`);
            const data = await res.json();

            if (myToken !== currentLoadToken) return; // a newer load started, abort
            
            const rows = data.messages || [];

            // sort ascending for display
            rows.sort((a, b) => {
                const ta = (a.metadata?.timestamp ?? 0);
                const tb = (b.metadata?.timestamp ?? 0);
                if (ta !== tb) return ta - tb;
                const ia = (a.metadata?.index ?? 0);
                const ib = (b.metadata?.index ?? 0);
                return ia - ib;
            });

            currentSession.messages = rows.map(r => ({
                role: (r.metadata?.message_type === 'llm') ? 'assistant' : 'user',
                content: r.document || '',
                timestamp: r.metadata?.timestamp
                ? new Date(r.metadata.timestamp * 1000).toISOString()
                : new Date().toISOString()
            }));

            renderConversation(currentSession.messages);
            updateSessionUI();
            // Just clear RAG results when loading a session
            // JUST CHECK AGAIN - NEEDS IMPROVEMENT - CHECK LOGIN AGAIN
            clearRAGResults();
        }



        
        function renderConversation(messages) {
            conversationHistory.innerHTML = '';
            
            if (messages.length === 0) {
                emptyConversation.classList.remove('hidden');
                return;
            }
            
            emptyConversation.classList.add('hidden');
            
            messages.forEach(message => {
                addMessageToConversation(message.role, message.content, message.timestamp);
            });
            
            // Scroll to bottom
            conversationHistory.scrollTop = conversationHistory.scrollHeight;
        }
        
        function addMessageToConversation(role, content, timestamp = new Date()) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const timeString = typeof timestamp === 'string' ? timestamp : timestamp.toLocaleTimeString();
            
            messageDiv.innerHTML = `
                <div class="message-content">
                    <div>${content}</div>
                    <div class="message-time">${timeString}</div>
                </div>
            `;
            
            conversationHistory.appendChild(messageDiv);
            emptyConversation.classList.add('hidden');
            
            // Scroll to bottom
            conversationHistory.scrollTop = conversationHistory.scrollHeight;
        }
        
        function simulateRAGResults(query) {
            // Clear previous results
            clearRAGResults();
            
            // Simulate RAG results based on the query
            const simulatedResults = [
                {
                    id: 1,
                    score: 0.95,
                    text: `The client specifically mentioned needing ${query.includes('dark mode') ? 'dark mode functionality' : 'responsive design'} for the dashboard. This was discussed during the project requirements meeting.`,
                    source: 'Project Requirements Discussion',
                    timestamp: '2 hours ago',
                    matches: query.includes('dark mode') ? ['dark mode'] : ['responsive design']
                },
                {
                    id: 2,
                    score: 0.87,
                    text: `API documentation indicates that authentication requires JWT tokens. ${query.includes('authentication') ? 'The authentication endpoint requires a JWT token in the header.' : 'Rate limiting is set to 100 requests per minute.'}`,
                    source: 'API Documentation Notes',
                    timestamp: 'Yesterday',
                    matches: query.includes('authentication') ? ['authentication', 'JWT'] : ['rate limiting']
                },
                {
                    id: 3,
                    score: 0.76,
                    text: `Q3 planning priorities include implementing user feedback systems and ${query.includes('analytics') ? 'adding advanced analytics dashboard' : 'improving mobile experience'}.`,
                    source: 'Meeting Notes: Q3 Planning',
                    timestamp: '2 days ago',
                    matches: query.includes('analytics') ? ['analytics', 'dashboard'] : ['mobile experience']
                }
            ];
            
            ragResults = simulatedResults;
            renderRAGResults();
        }
        
        function renderRAGResults() {
            ragResultsContainer.innerHTML = '';
            
            if (ragResults.length === 0) {
                emptyRagResults.classList.remove('hidden');
                return;
            }
            
            emptyRagResults.classList.add('hidden');
            
            ragResults.forEach(result => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'rag-result';
                resultDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="rag-score">${(result.score * 100).toFixed(0)}% match</span>
                        <button class="text-muted-foreground hover:text-foreground" onclick="toggleRAGResultSelection(${result.id})">
                            <i data-lucide="maximize-2" class="h-4 w-4"></i>
                        </button>
                    </div>
                    <div class="text-sm mb-3">
                        ${highlightMatches(result.text, result.matches)}
                    </div>
                    <div class="rag-meta">
                        <div>
                            <span class="font-medium">${result.source}</span>
                            <span class="ml-2">${result.timestamp}</span>
                        </div>
                        <div class="rag-feedback">
                            <button class="feedback-btn" onclick="rateRAGResult(${result.id}, 'helpful')">
                                <i data-lucide="thumbs-up" class="h-3 w-3"></i>
                            </button>
                            <button class="feedback-btn" onclick="rateRAGResult(${result.id}, 'not-helpful')">
                                <i data-lucide="thumbs-down" class="h-3 w-3"></i>
                            </button>
                        </div>
                    </div>
                `;
                ragResultsContainer.appendChild(resultDiv);
            });
            
            // Re-initialize Lucide icons for new elements
            lucide.createIcons();
        }
        
        function highlightMatches(text, matches) {
            let highlightedText = text;
            matches.forEach(match => {
                const regex = new RegExp(match, 'gi');
                highlightedText = highlightedText.replace(regex, '<span class="rag-text-match">$&</span>');
            });
            return highlightedText;
        }
        
        function clearRAGResults() {
            ragResults = [];
            ragResultsContainer.innerHTML = '';
            emptyRagResults.classList.remove('hidden');
        }
        
        // Global functions for RAG interaction
        window.toggleRAGResultSelection = function(resultId) {
            const result = ragResults.find(r => r.id === resultId);
            if (result) {
                // In a real implementation, this would update the AI response
                console.log('Selected RAG result:', result);
            }
        };
        
        window.rateRAGResult = function(resultId, rating) {
            const result = ragResults.find(r => r.id === resultId);
            if (result) {
                // In a real implementation, this would send feedback to the server
                console.log(`Rated result ${resultId} as ${rating}`);
                
                // Visual feedback
                const buttons = document.querySelectorAll(`.rag-result:nth-child(${ragResults.findIndex(r => r.id === resultId) + 1}) .feedback-btn`);
                buttons.forEach(btn => btn.classList.remove('active'));
                
                const targetBtn = rating === 'helpful' ? buttons[0] : buttons[1];
                targetBtn.classList.add('active');
            }
        };
        
        // Chat form submission
        chatForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const message = chatInput.value.trim();
            if (!message) return;

            chatInput.value = '';

            // Ensure a server session exists
            if (!currentSession) {
                await createNewSession();
            }

            // New logic here as well.
            const myToken = ++currentSendToken;
            const thisSessionId = currentSession.id;

            // Optimistic UI: show user message
            const userMessage = { role: 'user', content: message, timestamp: new Date().toISOString() };
            currentSession.messages.push(userMessage);
            addMessageToConversation('user', message);
            currentSession.updatedAt = new Date().toISOString();

            // Ask server to generate + store both messages in Chroma
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                thread_id: currentSession.id,   // UUID
                user_id: window.USER_ID,      // from base.html
                message,
                history: currentSession.messages
                })
            });

            const data = await res.json();

            // If user switched session during await, do not append to the new session
            if (myToken !== currentSendToken || !currentSession || currentSession.id !== thisSessionId) {
                // Optionally: silently ignore, or refresh that session in background
                return;
            }

            // Show assistant reply
            const aiMessage = { role: 'assistant', content: data.reply, timestamp: new Date().toISOString() };
            currentSession.messages.push(aiMessage);
            addMessageToConversation('assistant', data.reply);

            // Refresh sessions list metadata from server (optional)
            await refreshSessionsFromServer();
            renderSessionsList();

            // RAG panel: call real endpoint or clear
            clearRAGResults(); // replace with real fetch when ready
        });

        
        
        
        // Export functionality
        exportResultsBtn.addEventListener('click', function() {
            if (ragResults.length === 0) {
                alert('No results to export');
                return;
            }
            
            // Create CSV content
            const headers = ['Score', 'Source', 'Timestamp', 'Text'];
            const csvContent = [
                headers.join(','),
                ...ragResults.map(result => [
                    result.score,
                    `"${result.source}"`,
                    `"${result.timestamp}"`,
                    `"${result.text.replace(/"/g, '""')}"`
                ].join(','))
            ].join('\n');
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rag-results-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
        
        // New session button
        newSessionBtn.addEventListener('click', createNewSession);
        
        // Session dropdown change
        sessionDropdown.addEventListener('change', function() {
            if (this.value) {
                loadSession(parseInt(this.value));
            }
        });
        
        // Navigation items
        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                navItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                
                // Handle section switching
                const section = item.getAttribute('data-section');
                // In a full implementation, this would load different content based on the section
                console.log('Switching to section:', section);
            });
        });
        
        // Modal functionality (existing code)
        function showModal() {
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        function hideModal() {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
            // Do not reset file input here to preserve file selection when reopening modal
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function validateFileSize(file) {
            const maxSize = 25 * 1024 * 1024;
            return file.size <= maxSize;
        }
        
        // File selection state for modal
        let selectedFiles = [];

        function updateFileInputFiles() {
            const dataTransfer = new DataTransfer();
            selectedFiles.forEach(file => dataTransfer.items.add(file));
            fileInput.files = dataTransfer.files;
        }

        function showFilePreview(filesArr) {
            filePreview.innerHTML = '';
            filesArr.forEach((file, idx) => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'file-preview-item flex items-center justify-between mb-2 p-2 bg-secondary/30 rounded';
                fileDiv.innerHTML = `
                    <span class="truncate max-w-[180px]">${file.name}</span>
                    <span class="ml-2 text-xs text-muted-foreground">${formatFileSize(file.size)}</span>
                    <button type="button" class="ml-2 text-destructive hover:text-red-600 delete-file-btn" data-idx="${idx}" title="Remove file">
                        <i data-lucide="x" class="h-4 w-4"></i>
                    </button>
                `;
                filePreview.appendChild(fileDiv);
            });
            filePreview.classList.remove('hidden');
            fileError.classList.add('hidden');
            lucide.createIcons();
        }

        function hideFilePreview() {
            filePreview.classList.add('hidden');
            selectedFiles = [];
            updateFileInputFiles();
            fileInput.value = '';
        }

        function showFileError(message) {
            fileError.textContent = message;
            fileError.classList.remove('hidden');
            filePreview.classList.add('hidden');
        }

        function resetFileInput() {
            fileInput.value = '';
            selectedFiles = [];
            filePreview.classList.add('hidden');
            fileError.classList.add('hidden');
        }
        
        // Event listeners for modal
        addBtn.addEventListener('click', function() {
            showModal();
            // Only reset file input when opening modal for a new memory
            resetFileInput();
        });
        closeBtn.addEventListener('click', function() {
            hideModal();
            resetFileInput();
        });
        cancelBtn.addEventListener('click', function() {
            hideModal();
            resetFileInput();
        });
        modalBackdrop.addEventListener('click', function() {
            hideModal();
            resetFileInput();
        });
        
        fileInput.addEventListener('change', function() {
            if (this.files && this.files.length > 0) {
                for (let file of this.files) {
                    if (!validateFileSize(file)) {
                        showFileError('File size exceeds the maximum limit of 25MB');
                        return;
                    }
                }
                // Add new files to selectedFiles, avoiding duplicates by name+size
                Array.from(this.files).forEach(file => {
                    if (!selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
                        selectedFiles.push(file);
                    }
                });
                updateFileInputFiles();
                showFilePreview(selectedFiles);
            }
        });

        filePreview.addEventListener('click', function(e) {
            if (e.target.closest('.delete-file-btn')) {
                const idx = parseInt(e.target.closest('.delete-file-btn').getAttribute('data-idx'));
                selectedFiles.splice(idx, 1);
                updateFileInputFiles();
                if (selectedFiles.length > 0) {
                    showFilePreview(selectedFiles);
                } else {
                    hideFilePreview();
                }
            }
        });

        removeFileBtn.addEventListener('click', hideFilePreview);
        fileUploadBtn.addEventListener('click', (event) => {
            event.stopPropagation(); // Prevent click from bubbling to dropZone
            fileInput.click();
        });
        dropZone.addEventListener('click', () => fileInput.click());
        
        // Drag and drop functionality
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dropZone.classList.add('border-primary');
        }
        
        function unhighlight() {
            dropZone.classList.remove('border-primary');
        }
        
        dropZone.addEventListener('drop', handleDrop, false);
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files && files.length > 0) {
                for (let file of files) {
                    if (!validateFileSize(file)) {
                        showFileError('File size exceeds the maximum limit of 25MB');
                        return;
                    }
                }
                // Add dropped files to selectedFiles, avoiding duplicates
                Array.from(files).forEach(file => {
                    if (!selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
                        selectedFiles.push(file);
                    }
                });
                updateFileInputFiles();
                showFilePreview(selectedFiles);
            }
        }
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                hideModal();
            }
        });
    });

   



</script>
{% endblock %}