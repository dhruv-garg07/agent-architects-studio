{% extends "base.html" %}

{% block title %}GitMem{% endblock %}

{% block content %}
<!-- Main Layout -->
<div class="min-h-screen flex flex-col bg-background">

    <!-- Compact Floating Repo Nav (Mac + GitHub Style) -->
    <div class="sticky top-[74px] z-[40] w-full pointer-events-none mb-4">
        <div class="max-w-[1400px] mx-auto px-6">
            <div class="gh-floating-panel px-5 py-2.5 flex items-center relative pointer-events-auto min-h-[60px]">

                <!-- Left: Repo Identity (Fixed Width to prevent Jitter) -->
                <div class="flex items-center gap-4 w-[300px] shrink-0">
                    <div
                        class="w-10 h-10 rounded-[14px] bg-gradient-to-br from-primary to-accent-secondary flex items-center justify-center shadow-lg shadow-primary/20 shrink-0">
                        <i data-lucide="package" class="w-5 h-5 text-white"></i>
                    </div>
                    <div class="flex flex-col min-w-0">
                        <h2 class="text-[14px] font-bold text-white tracking-tight leading-none mb-1 truncate pr-4">
                            {{ agent.name if agent else 'Memory Repository' }}
                        </h2>
                        <div class="flex items-center gap-2 text-[10px] text-gray-400 font-medium">
                            <span
                                class="font-mono bg-[rgba(255,255,255,0.05)] px-1.5 py-0.5 rounded text-[9px] border border-[rgba(255,255,255,0.08)] shrink-0">
                                {{ agent.slug or agent.id[:8] if agent else 'PUBLIC' }}
                            </span>
                            {% if agent %}
                            <span class="flex items-center gap-1 truncate">
                                <span>{{ memory_count|default(0) }} memories</span>
                                <span class="mx-0.5">•</span>
                                <span>{{ commit_count|default(0) }} commits</span>
                            </span>
                            {% else %}
                            <span>GitMem Registry</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Center: Navigation Tabs (Absolutely Centered) -->
                <nav
                    class="gh-nav-pill flex items-center gap-1 absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2">
                    {% set nav_items = [
                    ('code', 'code-2', 'Code', 'gitmem.agent_dashboard' if agent else 'gitmem.landing'),
                    ('issues', 'circle-dot', 'Issues', 'gitmem.issues'),
                    ('pulls', 'git-pull-request', 'Pulls', 'gitmem.pulls'),
                    ] %}

                    {% set repo_routes = ['gitmem.agent_dashboard', 'gitmem.issues', 'gitmem.pulls', 'gitmem.actions',
                    'gitmem.projects', 'gitmem.insights', 'gitmem.settings'] %}

                    {% for id, icon, label, route in nav_items %}
                    <a href="{{ url_for(route, agent_id=agent.id) if agent and route in repo_routes else url_for(route) }}"
                        class="gh-nav-pill-item relative flex items-center gap-2 px-3 py-2 text-sm font-medium transition-all {{ 'active text-white' if active_page == id or (active_page == 'context' and id == 'code') else 'text-gray-400 hover:text-white hover:bg-white/5 rounded-md' }}">
                        <i data-lucide="{{ icon }}" class="w-4 h-4"></i>
                        <span>{{ label }}</span>
                        {% if active_page == id or (active_page == 'context' and id == 'code') %}
                        <span
                            class="absolute bottom-0 left-0 w-full h-[2px] bg-[#f78166] rounded-t-sm shadow-[0_0_8px_rgba(247,129,102,0.4)]"></span>
                        {% endif %}
                    </a>
                    {% endfor %}
                </nav>

                <!-- Right: Tool Drawer -->
                <div class="flex items-center gap-3 ml-auto shrink-0">
                    <div class="hidden lg:flex items-center gap-2 bg-white/5 p-1 rounded-xl border border-white/5 mr-2">
                        <button
                            class="h-8 px-3 rounded-lg text-gray-400 hover:text-white transition-all text-[11px] font-bold">Watch</button>
                        <div class="w-px h-3 bg-white/10"></div>
                        <button
                            class="h-8 px-3 rounded-lg text-gray-400 hover:text-white transition-all text-[11px] font-bold flex items-center gap-1.5">
                            <i data-lucide="star" class="w-3 h-3 text-warning"></i> Star
                        </button>
                    </div>

                    {% if agent %}
                    <button onclick="addMemory()"
                        class="h-10 px-5 rounded-2xl bg-primary text-white text-xs font-black hover:scale-[1.02] active:scale-[0.98] transition-all shadow-xl shadow-primary/25 flex items-center gap-2">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        <span class="hidden sm:inline">Add Memory</span>
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <main class="flex-1 py-4">
        <div class="max-w-[1400px] w-full mx-auto px-6">
            {% block repo_content %}{% endblock %}
        </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-white/5 py-12 text-center text-xs text-gray-500">
        <div class="flex items-center justify-center gap-2 mb-3">
            <div class="w-6 h-6 rounded-lg bg-primary/10 flex items-center justify-center">
                <i data-lucide="brain-circuit" class="w-3.5 h-3.5 text-primary"></i>
            </div>
            <span class="font-bold tracking-tight text-gray-300">GitMem</span>
        </div>
        <p>© 2026 Agent Architects Studio. Premium Dashboard Experience.</p>
    </footer>
</div>

<!-- Add Memory Modal -->
{% if agent %}
<div id="add-memory-modal" class="fixed inset-0 z-[100] hidden" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <div class="fixed inset-0 bg-black/80 backdrop-blur-md transition-opacity" onclick="closeModal()"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div
                class="relative transform overflow-hidden rounded-[32px] bg-[#1a1a1a] border border-white/10 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg p-1">
                <div class="bg-gradient-to-br from-white/5 to-transparent rounded-[31px] px-8 py-8">
                    <div class="flex items-center justify-between mb-8">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl bg-primary/10 flex items-center justify-center">
                                <i data-lucide="plus-circle" class="w-6 h-6 text-primary"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white">New Memory</h3>
                                <p class="text-xs text-gray-500">Add context to your agent's repository</p>
                            </div>
                        </div>
                        <button onclick="closeModal()"
                            class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/10 transition-all">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>

                    <form id="add-memory-form" onsubmit="submitMemory(event)">
                        <div class="space-y-6">
                            <div>
                                <label
                                    class="block text-[11px] font-black uppercase tracking-wider text-gray-500 mb-2 ml-1">Context
                                    Content</label>
                                <textarea name="content" rows="4" required
                                    class="w-full bg-black/20 border border-white/5 rounded-2xl p-4 text-sm text-white placeholder-gray-600 focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all resize-none"
                                    placeholder="Enter what you want your agent to remember..."></textarea>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label
                                        class="block text-[11px] font-black uppercase tracking-wider text-gray-500 mb-2 ml-1">Type</label>
                                    <div class="relative">
                                        <select name="type"
                                            class="w-full appearance-none bg-black/20 border border-white/5 rounded-2xl p-3 text-sm text-white focus:outline-none focus:ring-2 focus:ring-primary/50">
                                            <option value="episodic">Episodic (Event)</option>
                                            <option value="semantic">Semantic (Fact)</option>
                                            <option value="procedural">Procedural (Skill)</option>
                                        </select>
                                        <i data-lucide="chevron-down"
                                            class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-600 pointer-events-none"></i>
                                    </div>
                                </div>
                                <div>
                                    <label
                                        class="block text-[11px] font-black uppercase tracking-wider text-gray-500 mb-2 ml-1">Importance</label>
                                    <div
                                        class="flex items-center gap-3 bg-black/20 border border-white/5 rounded-2xl px-4 py-3">
                                        <input type="range" name="importance" min="0" max="1" step="0.1" value="0.5"
                                            class="w-full h-1 bg-white/10 rounded-lg appearance-none cursor-pointer accent-primary">
                                        <span class="text-xs font-mono text-primary w-6" id="importance-val">0.5</span>
                                    </div>
                                </div>
                            </div>

                            <div class="pt-4 flex justify-end gap-3">
                                <button type="button" onclick="closeModal()"
                                    class="px-6 py-3 rounded-2xl bg-white/5 text-gray-400 hover:text-white text-[13px] font-bold transition-all">Cancel</button>
                                <button type="submit"
                                    class="px-8 py-3 rounded-2xl bg-primary text-white shadow-lg shadow-primary/25 text-[13px] font-bold hover:scale-[1.02] active:scale-[0.98] transition-all">Save
                                    Memory</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
    const agentId = "{{ agent.id if agent else '' }}";

    function toggleFolderGroup(group) {
        const folders = document.getElementById(`${group}-folders`);
        const toggle = document.getElementById(`${group}-toggle`);
        if (folders) {
            folders.classList.toggle('hidden');
            if (toggle) toggle.classList.toggle('rotate-90');
            if (window.lucide) lucide.createIcons();
        }
    }

    function addMemory() {
        const modal = document.getElementById('add-memory-modal');
        if (modal) {
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
    }

    function closeModal() {
        const modal = document.getElementById('add-memory-modal');
        if (modal) {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }
    }

    function toggleMoreMenu() {
        const dropdown = document.getElementById('more-menu-dropdown');
        if (dropdown) dropdown.classList.toggle('hidden');
    }

    function handleBranchChange(branch) {
        console.log('Switching branch:', branch);
    }

    async function submitMemory(e) {
        e.preventDefault();
        const form = e.target;
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Saving...';

        const data = {
            agent_id: agentId,
            content: form.content.value,
            type: form.type.value,
            importance: parseFloat(form.importance.value)
        };

        try {
            const resp = await fetch('/gitmem/api/memory', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (resp.ok) {
                closeModal();
                window.location.reload();
            } else {
                alert('Failed to save memory');
            }
        } catch (e) {
            console.error('Failed to add memory:', e);
            alert('Error adding memory');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    }

    window.addEventListener('click', (e) => {
        if (!e.target.closest('.dropdown')) {
            const dropdown = document.getElementById('more-menu-dropdown');
            if (dropdown) dropdown.classList.add('hidden');
        }
    });

    document.addEventListener('DOMContentLoaded', function () {
        const rangeInput = document.querySelector('input[name="importance"]');
        if (rangeInput) {
            rangeInput.addEventListener('input', (e) => {
                const valElement = document.getElementById('importance-val');
                if (valElement) valElement.textContent = e.target.value;
            });
        }
        if (window.lucide) lucide.createIcons();
    });
</script>
{% endblock %}