{% extends "base.html" %}

{% block title %}Dashboard - AI Agent Marketplace{% endblock %}

{% block content %}
<div class="flex min-h-screen relative">

    <!-- Sidebar -->
    <div
        class="w-64 backdrop-blur-xl bg-black/40 border-r border-white/10 fixed left-0 top-14 bottom-0 overflow-y-auto hidden md:block">
        <nav class="p-4 mt-8">

            <!-- User Summary -->
            <div class="mb-8 px-2 flex items-center gap-3">
                <div
                    class="w-10 h-10 rounded-full bg-gradient-to-br from-primary/20 to-primary/10 flex items-center justify-center border border-primary/20">
                    <span class="font-bold text-primary">{{ profile.full_name[:1] }}</span>
                </div>
                <div class="overflow-hidden">
                    <p class="text-sm font-medium text-white truncate">{{ profile.full_name }}</p>
                    <p class="text-xs text-muted-foreground truncate">@{{ profile.username }}</p>
                </div>
            </div>

            <!-- Menu Groups -->
            <div class="mb-6">
                <h3 class="text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-2 px-2">Profile</h3>
                <ul class="space-y-1">
                    <li>
                        <a href="#overview"
                            class="nav-item flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-md text-gray-300 hover:bg-white/5 hover:text-white transition-all group">
                            <i data-lucide="user"
                                class="w-4 h-4 text-gray-500 group-hover:text-primary transition-colors"></i>
                            Overview
                        </a>
                    </li>
                    <li>
                        <a href="#settings"
                            class="nav-item flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-md text-gray-300 hover:bg-white/5 hover:text-white transition-all group">
                            <i data-lucide="settings"
                                class="w-4 h-4 text-gray-500 group-hover:text-primary transition-colors"></i>
                            Settings
                        </a>
                    </li>
                </ul>
            </div>

            <div class="mb-6">
                <h3 class="text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-2 px-2">Workspace
                </h3>
                <ul class="space-y-1">
                    <li>
                        <a href="#my-agents"
                            class="nav-item flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-md text-gray-300 hover:bg-white/5 hover:text-white transition-all group">
                            <i data-lucide="bot"
                                class="w-4 h-4 text-gray-500 group-hover:text-primary transition-colors"></i>
                            My Agents
                        </a>
                    </li>
                    <li>
                        <a href="#api-keys"
                            class="nav-item flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-md text-gray-300 hover:bg-white/5 hover:text-white transition-all group">
                            <i data-lucide="key"
                                class="w-4 h-4 text-gray-500 group-hover:text-primary transition-colors"></i>
                            API Keys
                        </a>
                    </li>
                    <li>
                        <a href="#billing"
                            class="nav-item flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-md text-gray-300 hover:bg-white/5 hover:text-white transition-all group">
                            <i data-lucide="credit-card"
                                class="w-4 h-4 text-gray-500 group-hover:text-primary transition-colors"></i>
                            Billing
                        </a>
                    </li>
                </ul>
            </div>

            <div class="mb-6">
                <h3 class="text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-2 px-2">Resources
                </h3>
                <ul class="space-y-1">
                    <li>
                        <a href="{{ url_for('api_docs') }}"
                            class="flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-md text-gray-300 hover:bg-white/5 hover:text-white transition-all group">
                            <i data-lucide="book-open"
                                class="w-4 h-4 text-gray-500 group-hover:text-primary transition-colors"></i>
                            API Docs
                        </a>
                    </li>
                    <li>
                        <a href="#support"
                            class="nav-item flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-md text-gray-300 hover:bg-white/5 hover:text-white transition-all group">
                            <i data-lucide="life-buoy"
                                class="w-4 h-4 text-gray-500 group-hover:text-primary transition-colors"></i>
                            Support
                        </a>
                    </li>
                </ul>
            </div>

        </nav>
    </div>

    <!-- Main Content -->
    <div class="md:ml-64 flex-1 overflow-auto">
        <div class="max-w-5xl mx-auto p-8">

            <!-- 1. Overview Section -->
            <section id="overview-content" class="content-section hidden animate-fade-in">
                <div class="relative mb-8">
                    <div
                        class="h-32 w-full bg-gradient-to-r from-primary/10 via-purple-500/5 to-blue-500/10 rounded-xl border border-white/5">
                    </div>
                    <div class="absolute -bottom-10 left-8 flex items-end">
                        <div class="w-24 h-24 rounded-full bg-[#111] p-1 border border-white/10">
                            <div
                                class="w-full h-full rounded-full bg-secondary flex items-center justify-center overflow-hidden">
                                <i data-lucide="user" class="w-10 h-10 text-gray-400"></i>
                            </div>
                        </div>
                        <div class="ml-4 mb-2">
                            <h1 class="text-2xl font-bold text-white">{{ profile.full_name }}</h1>
                            <p class="text-gray-400 text-sm">@{{ profile.username }}</p>
                        </div>
                    </div>
                </div>

                <div class="mt-14 grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Left: Details -->
                    <div class="space-y-6">
                        <div class="p-6 rounded-xl bg-white/5 border border-white/10">
                            <h3 class="text-sm font-semibold text-gray-300 mb-4 uppercase tracking-wide">About</h3>
                            <div class="space-y-4">
                                <div>
                                    <span class="text-xs text-gray-500 block mb-1">Role</span>
                                    <span
                                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary/10 text-primary border border-primary/20">
                                        {{ profile.user_role | capitalize }}
                                    </span>
                                </div>
                                <div>
                                    <span class="text-xs text-gray-500 block mb-1">Joined</span>
                                    <div class="flex items-center text-sm text-gray-300">
                                        <i data-lucide="calendar" class="w-3 h-3 mr-2 text-gray-500"></i>
                                        {{ profile.created_at.split('T')[0] }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Activity -->
                    <div class="md:col-span-2 space-y-6">
                        <div class="p-6 rounded-xl bg-white/5 border border-white/10">
                            <h3 class="text-sm font-semibold text-gray-300 mb-4">Activity</h3>
                            <div class="flex items-end justify-between h-24 gap-1">
                                {% for i in range(20) %}
                                <div class="w-full bg-primary/20 hover:bg-primary/40 rounded-sm transition-colors"
                                    style="height: {{ range(10, 100) | random }}%"></div>
                                {% endfor %}
                            </div>
                            <p class="text-xs text-muted-foreground text-center mt-3">Recent interactions</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 2. Settings (Edit Profile) Section -->
            <section id="settings-content" class="content-section hidden animate-fade-in">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-white tracking-tight">Edit Profile</h2>
                    <p class="text-gray-400">Update your personal information.</p>
                </div>

                <div class="p-6 rounded-xl bg-white/5 border border-white/10">
                    <form action="{{ url_for('edit_profile') }}" method="POST" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Full Name</label>
                                <input type="text" name="full_name" value="{{ profile.full_name or '' }}" required
                                    class="w-full bg-black/50 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-1 focus:ring-primary transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Username</label>
                                <input type="text" name="username" value="{{ profile.username or '' }}" required
                                    class="w-full bg-black/50 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-1 focus:ring-primary transition-all">
                            </div>
                        </div>

                        {% if profile.user_role == 'creator' %}
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Portfolio</label>
                                <input type="url" name="portfolio_url" value="{{ profile.portfolio_url or '' }}"
                                    placeholder="https://..."
                                    class="w-full bg-black/50 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-1 focus:ring-primary transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Expertise</label>
                                <input type="text" name="expertise" value="{{ profile.expertise or '' }}"
                                    placeholder="AI, Python..."
                                    class="w-full bg-black/50 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-1 focus:ring-primary transition-all">
                            </div>
                        </div>
                        {% endif %}

                        <div class="pt-4 border-t border-white/10 flex justify-end">
                            <button type="submit" class="btn-primary flex items-center">
                                <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                                Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- 3. My Agents Section -->
            <section id="my-agents-content" class="content-section hidden animate-fade-in">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-white tracking-tight">My Agents</h2>
                    <p class="text-gray-400">Browse and manage the agents you own or have access to.</p>
                </div>

                <div class="backdrop-blur-xl bg-white/5 border border-white/10 rounded-xl p-4 mb-6">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                        <input id="agent-search" type="search" placeholder="Search agents..."
                            class="w-full sm:w-1/2 px-3 py-2 bg-black/50 border border-white/10 rounded-md focus:outline-none focus:ring-1 focus:ring-primary text-white placeholder-gray-500" />
                        <div class="flex items-center gap-2">
                            <button id="create-agent-btn" class="btn-primary flex items-center text-sm">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                Create Agent
                            </button>
                            <button id="refresh-agents" class="btn-secondary flex items-center">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <div id="agents-empty" class="p-8 text-center text-muted-foreground hidden">
                        <i data-lucide="box" class="w-12 h-12 mx-auto text-gray-600 mb-4"></i>
                        <p class="text-lg mb-2">No agents found</p>
                        <p class="text-sm">Create or import agents to see them here</p>
                    </div>

                    <div id="agents-container"
                        class="grid gap-6 grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div>
                </div>
            </section>

            <!-- 4. API Keys Section -->
            <section id="api-keys-content" class="content-section hidden animate-fade-in">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-white tracking-tight">API Keys</h2>
                        <p class="text-gray-400">Manage your API keys to access models</p>
                    </div>
                    <button id="open-create-modal-btn" class="btn-primary flex items-center text-sm">
                        <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                        Create New Key
                    </button>
                </div>

                <div class="backdrop-blur-xl bg-white/5 border border-white/10 rounded-xl overflow-hidden mb-6">
                    <table class="min-w-full divide-y divide-white/10">
                        <thead class="bg-white/5">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                    Name</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                    Key</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                    Limit / Exp</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                    Usage</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="api-keys-table-body" class="divide-y divide-white/10 bg-transparent">
                            <!-- Keys populated dynamically -->
                        </tbody>
                    </table>

                    <div id="empty-state" class="hidden p-8 text-center text-muted-foreground">
                        No API keys found. Create one to get started.
                    </div>
                </div>
            </section>

            <!-- 5. Billing Section -->
            <section id="billing-content" class="content-section hidden animate-fade-in">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-white tracking-tight">Billing & Plans</h2>
                    <p class="text-gray-400">Manage your subscription and payment methods.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- Current Plan Card -->
                    <div
                        class="p-6 rounded-xl bg-gradient-to-br from-primary/10 to-primary/5 border border-primary/20 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-10">
                            <i data-lucide="credit-card" class="w-24 h-24 text-primary"></i>
                        </div>
                        <div class="relative z-10">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-sm font-semibold text-primary uppercase tracking-wide">Current Plan</h3>
                                <span
                                    class="px-2 py-1 rounded-full bg-primary/20 text-primary text-xs font-bold">FREE</span>
                            </div>
                            <div class="text-3xl font-bold text-white mb-2">$0 <span
                                    class="text-sm text-gray-400 font-normal">/mo</span></div>
                            <p class="text-sm text-gray-400 mb-6">Developer Plan</p>
                            <button class="btn-primary w-full">Upgrade Plan</button>
                        </div>
                    </div>

                    <!-- Usage Stats (Mock) -->
                    <div class="p-6 rounded-xl bg-white/5 border border-white/10">
                        <h3 class="text-sm font-semibold text-gray-300 mb-4 uppercase tracking-wide">Usage</h3>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-gray-400">API Calls</span>
                                    <span class="text-white">124 / 1,000</span>
                                </div>
                                <div class="w-full bg-white/5 rounded-full h-1.5">
                                    <div class="bg-primary h-1.5 rounded-full" style="width: 12%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-gray-400">Agents</span>
                                    <span class="text-white">2 / 5</span>
                                </div>
                                <div class="w-full bg-white/5 rounded-full h-1.5">
                                    <div class="bg-green-500 h-1.5 rounded-full" style="width: 40%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="backdrop-blur-xl bg-white/5 border border-white/10 rounded-xl overflow-hidden">
                    <div class="px-6 py-4 border-b border-white/10 flex justify-between items-center">
                        <h3 class="text-lg font-medium text-white">Payment History</h3>
                        <button class="text-xs text-primary hover:underline">Download All</button>
                    </div>
                    <div class="p-8 text-center text-gray-500">
                        <i data-lucide="file-text" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                        <p>No payment history found.</p>
                    </div>
                </div>
            </section>

            <!-- 6. Support Section -->
            <section id="support-content" class="content-section hidden animate-fade-in">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-white tracking-tight">Support Center</h2>
                    <p class="text-gray-400">Get help with your agents and account.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Founder Contact -->
                    <div
                        class="p-6 rounded-xl bg-gradient-to-br from-purple-500/10 to-blue-500/10 border border-white/10 hover:border-primary/50 transition-all group">
                        <div
                            class="w-12 h-12 rounded-lg bg-white/5 flex items-center justify-center mb-4 group-hover:bg-primary/20 transition-colors">
                            <i data-lucide="message-circle" class="w-6 h-6 text-white"></i>
                        </div>
                        <h3 class="text-lg font-bold text-white mb-2">Contact Founder</h3>
                        <p class="text-sm text-gray-400 mb-6 min-h-[40px]">Direct line to Harshit (Founder) for
                            enterprise inquiries and partnership opportunities.</p>
                        <a href="/harshit"
                            class="inline-flex items-center text-sm font-medium text-primary hover:text-white transition-colors">
                            Visit Contact Page <i data-lucide="arrow-right" class="w-4 h-4 ml-2"></i>
                        </a>
                    </div>

                    <!-- Documentation -->
                    <div
                        class="p-6 rounded-xl bg-[#161616] border border-white/10 hover:border-white/20 transition-all group">
                        <div
                            class="w-12 h-12 rounded-lg bg-white/5 flex items-center justify-center mb-4 group-hover:bg-white/10 transition-colors">
                            <i data-lucide="book" class="w-6 h-6 text-white"></i>
                        </div>
                        <h3 class="text-lg font-bold text-white mb-2">Documentation</h3>
                        <p class="text-sm text-gray-400 mb-6 min-h-[40px]">Comprehensive guides on building agents, API
                            references, and SDK usages.</p>
                        <a href="{{ url_for('api_docs') }}"
                            class="inline-flex items-center text-sm font-medium text-primary hover:text-white transition-colors">
                            Read Docs <i data-lucide="arrow-right" class="w-4 h-4 ml-2"></i>
                        </a>
                    </div>
                </div>

                <div class="mt-8 p-6 rounded-xl bg-white/5 border border-white/10">
                    <h3 class="text-sm font-semibold text-gray-300 mb-4 uppercase tracking-wide">Common Issues</h3>
                    <div class="space-y-4">
                        <details class="group">
                            <summary
                                class="flex items-center justify-between cursor-pointer list-none text-sm text-white font-medium">
                                <span>How do I increase my API limit?</span>
                                <span class="transition group-open:rotate-180">
                                    <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500"></i>
                                </span>
                            </summary>
                            <p class="text-sm text-gray-400 mt-2 pl-4 border-l-2 border-white/10">
                                You can upgrade your plan in the <a href="#billing"
                                    onclick="document.querySelector('a[href=\'#billing\']').click()"
                                    class="text-primary hover:underline">Billing section</a> to get higher rate limits
                                instantly.
                            </p>
                        </details>
                        <div class="w-full h-px bg-white/5"></div>
                        <details class="group">
                            <summary
                                class="flex items-center justify-between cursor-pointer list-none text-sm text-white font-medium">
                                <span>Where can I find my API Key?</span>
                                <span class="transition group-open:rotate-180">
                                    <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500"></i>
                                </span>
                            </summary>
                            <p class="text-sm text-gray-400 mt-2 pl-4 border-l-2 border-white/10">
                                Navigate to the <a href="#api-keys"
                                    onclick="document.querySelector('a[href=\'#api-keys\']').click()"
                                    class="text-primary hover:underline">API Keys tab</a> in your workspace dashboard.
                            </p>
                        </details>
                    </div>
                </div>
            </section>

        </div>
    </div>
</div>

<!-- Modals (Agent & API Key) -->
<!-- Create/Edit Agent Modal -->
<div id="agent-modal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm transition-opacity"></div>
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div
                class="relative transform overflow-hidden rounded-xl bg-[#1a1a1a] border border-white/10 text-left shadow-2xl transition-all sm:w-full sm:max-w-lg">
                <div class="p-6">
                    <h3 class="text-lg font-semibold text-white mb-4" id="modal-title">Create New Agent</h3>
                    <div class="space-y-4">
                        <input type="hidden" id="agent-id">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">Agent Name</label>
                            <input type="text" id="agent-name"
                                class="w-full bg-black/50 border border-white/10 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-1 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">Slug</label>
                            <input type="text" id="agent-slug"
                                class="w-full bg-black/50 border border-white/10 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-1 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">Description</label>
                            <textarea id="agent-description" rows="3"
                                class="w-full bg-black/50 border border-white/10 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-1 focus:ring-primary"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-1">Status</label>
                                <select id="agent-status"
                                    class="w-full bg-black/50 border border-white/10 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-1 focus:ring-primary">
                                    <option value="active">Active</option>
                                    <option value="disabled">Disabled</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-1">RPM Limit</label>
                                <input type="number" id="agent-rpm" value="10"
                                    class="w-full bg-black/50 border border-white/10 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-1 focus:ring-primary">
                            </div>
                        </div>
                        <input type="hidden" id="agent-run-permission" value="true">
                    </div>
                </div>
                <div class="bg-white/5 px-6 py-4 flex flex-row-reverse gap-3">
                    <button type="button" id="confirm-agent-btn" class="btn-primary text-sm">Save Agent</button>
                    <button type="button" id="cancel-agent-btn"
                        class="px-4 py-2 text-sm text-gray-300 hover:text-white">Cancel</button>
                    <button type="button" id="delete-agent-btn"
                        class="hidden text-red-400 hover:text-red-300 text-sm mr-auto">Delete</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- API Key Creation Modal -->
<div id="create-key-modal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm transition-opacity"></div>
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div
                class="relative transform overflow-hidden rounded-xl bg-[#1a1a1a] border border-white/10 text-left shadow-2xl transition-all sm:w-full sm:max-w-md">
                <div class="p-6">
                    <h3 class="text-lg font-semibold text-white mb-4">Create API Key</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">Key Name</label>
                            <input type="text" id="key-name" placeholder="e.g. My App Key"
                                class="w-full bg-black/50 border border-white/10 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-1 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">Expiration</label>
                            <select id="key-expiration"
                                class="w-full bg-black/50 border border-white/10 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-1 focus:ring-primary">
                                <option value="">Never</option>
                                <option value="30">30 days</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="bg-white/5 px-6 py-4 flex flex-row-reverse gap-3">
                    <button type="button" id="confirm-create-key-btn" class="btn-primary text-sm">Create</button>
                    <button type="button" id="cancel-create-key-btn"
                        class="px-4 py-2 text-sm text-gray-300 hover:text-white">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Show Key Modal -->
<div id="show-key-modal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm transition-opacity"></div>
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div
                class="relative transform overflow-hidden rounded-xl bg-[#1a1a1a] border border-white/10 text-left shadow-2xl transition-all sm:w-full sm:max-w-md">
                <div class="p-6 text-center">
                    <div class="w-12 h-12 rounded-full bg-green-500/10 flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="check" class="w-6 h-6 text-green-500"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-white mb-2">API Key Created</h3>
                    <p class="text-sm text-gray-400 mb-4">Copy this key now. You won't be able to see it again.</p>

                    <div class="bg-black/50 border border-white/10 rounded p-3 mb-4 font-mono text-sm text-primary break-all"
                        id="show-key-value"></div>

                    <button id="close-show-key-btn" class="btn-secondary w-full">I've copied it</button>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        lucide.createIcons();

        // --- Tab Switching Logic ---
        const navItems = document.querySelectorAll('.nav-item');
        const contentSections = document.querySelectorAll('.content-section');

        function switchContent(targetId) {
            const id = targetId.replace('#', '');

            navItems.forEach(item => {
                const href = item.getAttribute('href').replace('#', '');
                if (href === id) {
                    item.classList.add('bg-white/10', 'text-white');
                    item.classList.remove('text-gray-300');
                    // Update icon color if needed
                    const icon = item.querySelector('svg');
                    if (icon) icon.classList.add('text-primary');
                } else {
                    item.classList.remove('bg-white/10', 'text-white');
                    item.classList.add('text-gray-300');
                    const icon = item.querySelector('svg');
                    if (icon) icon.classList.remove('text-primary');
                }
            });

            contentSections.forEach(section => {
                if (section.id === id + '-content') {
                    section.classList.remove('hidden');
                } else {
                    section.classList.add('hidden');
                }
            });
        }

        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const target = item.getAttribute('href');
                switchContent(target);
                history.pushState(null, null, target);
            });
        });

        if (window.location.hash) {
            switchContent(window.location.hash);
        } else {
            // Default to overview
            switchContent('overview');
            // Mark Overview link as active visually
            const overviewLink = document.querySelector('a[href="#overview"]');
            if (overviewLink) {
                overviewLink.classList.add('bg-white/10', 'text-white');
            }
        }

        // --- Existing Dashboard Functionality (Agents & Keys) ---
        // Ported reasonably to match new IDs

        // Agent Modal
        const agentModal = document.getElementById('agent-modal');
        const createAgentBtn = document.getElementById('create-agent-btn');
        const cancelAgentBtn = document.getElementById('cancel-agent-btn');
        const confirmAgentBtn = document.getElementById('confirm-agent-btn');
        const refreshAgentsBtn = document.getElementById('refresh-agents');
        const agentSearch = document.getElementById('agent-search');
        const agentsContainer = document.getElementById('agents-container');
        const agentsEmpty = document.getElementById('agents-empty');

        // Modals Toggle
        function toggleModal(modal, show) {
            if (show) modal.classList.remove('hidden');
            else modal.classList.add('hidden');
        }

        if (createAgentBtn) createAgentBtn.addEventListener('click', () => {
            // Reset form
            document.getElementById('agent-id').value = '';
            document.getElementById('agent-name').value = '';
            document.getElementById('agent-slug').value = '';
            document.getElementById('agent-description').value = '';
            document.getElementById('modal-title').textContent = 'Create New Agent';
            toggleModal(agentModal, true);
        });

        if (cancelAgentBtn) cancelAgentBtn.addEventListener('click', () => toggleModal(agentModal, false));

        // Auto Slug
        const nameInput = document.getElementById('agent-name');
        const slugInput = document.getElementById('agent-slug');
        if (nameInput) {
            nameInput.addEventListener('input', function () {
                if (!document.getElementById('agent-id').value) {
                    slugInput.value = this.value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
                }
            });
        }

        // Load Agents
        async function loadAgents() {
            try {
                const res = await fetch('/dashboard/agents', { credentials: 'same-origin' });
                const payload = await res.json();
                let agents = Array.isArray(payload) ? payload : (payload.data || payload.agents || []);

                agentsContainer.innerHTML = '';
                if (agents.length === 0) {
                    agentsEmpty.classList.remove('hidden');
                    return;
                }
                agentsEmpty.classList.add('hidden');

                agents.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                agents.forEach(agent => {
                    const card = document.createElement('div');
                    card.className = "bg-[#161616] border border-white/5 rounded-xl p-5 hover:border-primary/50 transition-all";
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
                                    <i data-lucide="bot" class="w-5 h-5 text-primary"></i>
                                </div>
                                <div>
                                    <h4 class="font-medium text-white">${agent.agent_name || agent.name}</h4>
                                    <p class="text-xs text-gray-500">${agent.agent_slug}</p>
                                </div>
                            </div>
                           <button class="bg-white/5 hover:bg-white/10 p-2 rounded-lg text-gray-400 hover:text-white transition-colors edit-btn">
                                <i data-lucide="edit-3" class="w-4 h-4"></i>
                           </button>
                        </div>
                        <p class="text-sm text-gray-400 line-clamp-2 mb-4 h-10">${agent.description || 'No description'}</p>
                        <div class="flex items-center justify-between pt-3 border-t border-white/5">
                            <span class="text-xs px-2 py-1 rounded-full ${agent.status === 'active' ? 'bg-green-500/10 text-green-500' : 'bg-gray-500/10 text-gray-500'} uppercase font-bold tracking-wide">
                                ${agent.status}
                            </span>
                            <a href="/agents/${agent.agent_id || agent.id}" class="text-xs font-medium text-primary hover:underline">Open Agent &rarr;</a>
                        </div>
                     `;

                    // Edit handler
                    card.querySelector('.edit-btn').addEventListener('click', () => {
                        document.getElementById('agent-id').value = agent.agent_id || agent.id;
                        document.getElementById('agent-name').value = agent.agent_name || agent.name;
                        document.getElementById('agent-slug').value = agent.agent_slug;
                        document.getElementById('agent-description').value = agent.description;
                        document.getElementById('modal-title').textContent = 'Edit Agent';
                        toggleModal(agentModal, true);
                    });

                    agentsContainer.appendChild(card);
                });
                lucide.createIcons();

            } catch (e) {
                console.error("Failed to load agents", e);
            }
        }

        // Agent Save
        if (confirmAgentBtn) {
            confirmAgentBtn.addEventListener('click', async () => {
                const id = document.getElementById('agent-id').value;
                const isEdit = !!id;
                const url = isEdit ? `/dashboard/update/${id}` : '/dashboard/create';
                const method = isEdit ? 'PUT' : 'POST';
                const body = {
                    agent_name: document.getElementById('agent-name').value,
                    agent_slug: document.getElementById('agent-slug').value,
                    description: document.getElementById('agent-description').value,
                    status: document.getElementById('agent-status').value,
                    limits: { rpm: parseInt(document.getElementById('agent-rpm').value) || 10 },
                    permissions: { run: true }
                };

                try {
                    const res = await fetch(url, {
                        method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
                    });
                    if (res.ok) {
                        toggleModal(agentModal, false);
                        loadAgents();
                    } else {
                        alert("Failed to save");
                    }
                } catch (e) {
                    console.error(e);
                }
            });
        }

        if (refreshAgentsBtn) refreshAgentsBtn.addEventListener('click', loadAgents);

        // Initial Load
        loadAgents();
        loadApiKeys(); // Load keys on startup

        // --- API Key Logic ---
        const apiKeysTableBody = document.getElementById('api-keys-table-body');
        const emptyState = document.getElementById('empty-state');
        const createKeyModal = document.getElementById('create-key-modal');
        const showKeyModal = document.getElementById('show-key-modal');

        // Buttons
        const openCreateKeyBtn = document.getElementById('open-create-modal-btn');
        const cancelCreateKeyBtn = document.getElementById('cancel-create-key-btn');
        const confirmCreateKeyBtn = document.getElementById('confirm-create-key-btn');
        const closeShowKeyBtn = document.getElementById('close-show-key-btn');

        if (openCreateKeyBtn) openCreateKeyBtn.addEventListener('click', () => {
            document.getElementById('key-name').value = '';
            toggleModal(createKeyModal, true);
        });

        if (cancelCreateKeyBtn) cancelCreateKeyBtn.addEventListener('click', () => toggleModal(createKeyModal, false));
        if (closeShowKeyBtn) closeShowKeyBtn.addEventListener('click', () => toggleModal(showKeyModal, false));

        async function loadApiKeys() {
            try {
                const res = await fetch('/api/keys', { credentials: 'same-origin' });
                const keys = await res.json();

                apiKeysTableBody.innerHTML = '';

                if (!Array.isArray(keys) || keys.length === 0) {
                    emptyState.classList.remove('hidden');
                    return;
                }
                emptyState.classList.add('hidden');

                keys.forEach(key => {
                    const row = document.createElement('tr');
                    row.className = "hover:bg-white/5 transition-colors";
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${key.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 font-mono">${key.masked_key}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${key.expiration || 'Never'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 text-center">Active</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right">
                             <button class="text-red-400 hover:text-red-300 delete-key-btn" data-id="${key.id}">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    `;
                    // Delete handler
                    row.querySelector('.delete-key-btn').addEventListener('click', async function () {
                        if (confirm('Revoke this API Key?')) {
                            const id = this.getAttribute('data-id');
                            await fetch(`/api/keys/${id}`, { method: 'DELETE', credentials: 'same-origin' });
                            loadApiKeys();
                        }
                    });

                    apiKeysTableBody.appendChild(row);
                });
                lucide.createIcons();

            } catch (e) {
                console.error("Failed to load keys", e);
            }
        }

        if (confirmCreateKeyBtn) {
            confirmCreateKeyBtn.addEventListener('click', async () => {
                const name = document.getElementById('key-name').value;
                const expiration = document.getElementById('key-expiration').value;

                try {
                    const res = await fetch('/api/keys', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, expiration })
                    });

                    if (res.ok) {
                        const data = await res.json();
                        toggleModal(createKeyModal, false);
                        loadApiKeys();

                        // Show the secret key
                        document.getElementById('show-key-value').textContent = data.key;
                        toggleModal(showKeyModal, true);
                    } else {
                        alert("Failed to create key");
                    }
                } catch (e) {
                    console.error(e);
                }
            });
        }
    });
</script>

<style>
    .animate-fade-in {
        animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}