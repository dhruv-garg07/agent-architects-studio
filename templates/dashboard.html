{% extends "base.html" %}

{% block title %}Dashboard - AI Agent Marketplace{% endblock %}

{% block content %}
<div class="flex min-h-screen bg-background relative">
    
    <!-- Sidebar -->
    <div class="w-64 bg-card border-r border-border fixed left-0 top-16 bottom-0 overflow-y-auto">
        <nav class="p-4 mt-17">
            <div class="mb-6">
                <h3 class="text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-3">Main</h3>
                <ul>
                    <li class="mb-2">
                        <a href="#account" class="nav-item active">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                            <span>Account</span>
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="#my-agents" class="nav-item">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" /></svg>
                            <span>My Agents</span>
                        </a>
                    </li>
                    <li>
                        <a href="#api-keys" class="nav-item">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" /></svg>
                            <span>API Keys</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="ml-64 flex-1 overflow-auto">
        <div class="p-8">
            
            <!-- Account Section -->
            <section id="account-content" class="content-section active">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-foreground">Account Settings</h2>
                    <p class="text-muted-foreground">Manage your account preferences</p>
                </div>
                <div class="card card-elevated p-6 mb-6">
                    <p class="text-muted-foreground">Account content placeholder...</p>
                </div>
            </section>
            
            <!-- My Agents Section -->
            <section id="my-agents-content" class="content-section hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-foreground">My Agents</h2>
                    <p class="text-muted-foreground">Browse and manage the agents you own or have access to.</p>
                </div>

                <div class="card card-elevated p-4 mb-6">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                        <input id="agent-search" type="search" placeholder="Search agents by name or description..." class="w-full sm:w-1/2 px-3 py-2 bg-background border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-primary" />
                        <div class="flex items-center gap-2">
                            <button id="create-agent-btn" class="bg-primary text-primary-foreground px-4 py-2 rounded-md hover:bg-primary/90 transition-colors flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                Create Agent
                            </button>
                            <button id="refresh-agents" class="bg-secondary text-secondary-foreground px-3 py-2 rounded-md hover:bg-secondary/90 transition-colors flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div id="agents-empty" class="p-8 text-center text-muted-foreground hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-muted-foreground mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                        </svg>
                        <p class="text-lg mb-2">No agents found</p>
                        <p class="text-sm">Create or import agents to see them here</p>
                    </div>

                    <div id="agents-container" class="grid gap-6 grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div>
                </div>
            </section>
            
            <!-- API Keys Section -->
            <section id="api-keys-content" class="content-section hidden">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-foreground">API Keys</h2>
                        <p class="text-muted-foreground">Manage your API keys to access models</p>
                    </div>
                    <button id="open-create-modal-btn" class="bg-primary text-primary-foreground px-4 py-2 rounded-md hover:bg-primary/90 transition-colors flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Create New Key
                    </button>
                </div>
                
                <div class="card card-elevated overflow-hidden mb-6">
                    <table class="min-w-full divide-y divide-border">
                        <thead class="bg-muted">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Key</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Limit / Exp</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Usage</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="api-keys-table-body" class="divide-y divide-border bg-card">
                            <!-- Keys will be populated dynamically from Supabase via /api/keys -->
                        </tbody>
                    </table>
                    
                    <div id="empty-state" class="hidden p-8 text-center text-muted-foreground">
                        No API keys found. Create one to get started.
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>

<!-- Create/Edit Agent Modal -->
<div id="agent-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm transition-opacity"></div>

    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-lg bg-card text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg border border-border">
                <div class="bg-card px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                            <h3 class="text-lg font-semibold leading-6 text-foreground" id="modal-title">Create New Agent</h3>
                            <div class="mt-4 space-y-4">
                                <input type="hidden" id="agent-id">
                                <div>
                                    <label for="agent-name" class="block text-sm font-medium text-foreground mb-1">Agent Name</label>
                                    <input type="text" id="agent-name" class="w-full px-3 py-2 bg-background border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-primary" placeholder="e.g. Customer Support Bot">
                                </div>
                                <div>
                                    <label for="agent-slug" class="block text-sm font-medium text-foreground mb-1">Agent Slug</label>
                                    <input type="text" id="agent-slug" class="w-full px-3 py-2 bg-background border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-primary" placeholder="e.g. customer-support">
                                </div>
                                <div>
                                    <label for="agent-description" class="block text-sm font-medium text-foreground mb-1">Description</label>
                                    <textarea id="agent-description" rows="3" class="w-full px-3 py-2 bg-background border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-primary" placeholder="What does this agent do?"></textarea>
                                </div>
                                <div>
                                    <label for="agent-status" class="block text-sm font-medium text-foreground mb-1">Status</label>
                                    <select id="agent-status" class="w-full px-3 py-2 bg-background border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                        <option value="draft">Draft</option>
                                    </select>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="agent-rpm" class="block text-sm font-medium text-foreground mb-1">RPM Limit</label>
                                        <input type="number" id="agent-rpm" class="w-full px-3 py-2 bg-background border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-primary" value="10">
                                    </div>
                                    <div>
                                        <label for="agent-run-permission" class="block text-sm font-medium text-foreground mb-1">Run Permission</label>
                                        <select id="agent-run-permission" class="w-full px-3 py-2 bg-background border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                                            <option value="true">Enabled</option>
                                            <option value="false">Disabled</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-muted/50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 gap-3">
                    <button type="button" id="confirm-agent-btn" class="inline-flex w-full justify-center rounded-md bg-primary px-3 py-2 text-sm font-semibold text-primary-foreground shadow-sm hover:bg-primary/90 sm:ml-3 sm:w-auto">Save Agent</button>
                    <button type="button" id="delete-agent-btn" class="inline-flex w-full justify-center rounded-md bg-destructive px-3 py-2 text-sm font-semibold text-destructive-foreground shadow-sm hover:bg-destructive/90 sm:w-auto hidden">Delete</button>
                    <button type="button" id="cancel-agent-btn" class="mt-3 inline-flex w-full justify-center rounded-md bg-background px-3 py-2 text-sm font-semibold text-foreground shadow-sm ring-1 ring-inset ring-border hover:bg-muted sm:mt-0 sm:w-auto">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirm-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="confirm-modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm transition-opacity"></div>
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-lg bg-card text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-md border border-border">
                <div class="bg-card px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                            <h3 class="text-lg font-semibold leading-6 text-foreground" id="confirm-modal-title">Delete Agent</h3>
                            <div class="mt-2">
                                <p class="text-sm text-muted-foreground" id="confirm-modal-message">Are you sure you want to delete this agent? This action cannot be undone.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-muted/50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                    <button type="button" id="confirm-delete-btn" class="inline-flex w-full justify-center rounded-md bg-destructive px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:ml-3 sm:w-auto">Delete</button>
                    <button type="button" id="cancel-delete-btn" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- API Key Modals (existing from your code) -->
<div id="create-key-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- ... existing create key modal content ... -->
</div>

<div id="show-key-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- ... existing show key modal content ... -->
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Color variables for consistent theme
        const colors = {
            primary: 'hsl(221.2 83.2% 53.3%)',
            primaryForeground: 'hsl(210 40% 98%)',
            background: 'hsl(0 0% 100%)',
            card: 'hsl(0 0% 100%)',
            border: 'hsl(214.3 31.8% 91.4%)',
            muted: 'hsl(210 40% 96.1%)',
            mutedForeground: 'hsl(215.4 16.3% 46.9%)',
            destructive: 'hsl(0 84.2% 60.2%)'
        };

        // --- Navigation Logic ---
        const navItems = document.querySelectorAll('.nav-item');
        const contentSections = document.querySelectorAll('.content-section');
        
        function switchContent(target) {
            navItems.forEach(item => item.classList.remove('active'));
            contentSections.forEach(section => section.classList.add('hidden'));
            const activeLink = document.querySelector(`a[href="${target}"]`);
            if(activeLink) activeLink.classList.add('active');
            const targetSection = document.querySelector(`${target}-content`);
            if(targetSection) targetSection.classList.remove('hidden');
        }
        
        navItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const target = this.getAttribute('href');
                switchContent(target);
                history.pushState(null, null, target);
            });
        });

        if (window.location.hash) {
            switchContent(window.location.hash);
        }

        // --- Agent CRUD Functions ---
        const agentModal = document.getElementById('agent-modal');
        const confirmModal = document.getElementById('confirm-modal');
        const createAgentBtn = document.getElementById('create-agent-btn');
        const refreshAgentsBtn = document.getElementById('refresh-agents');
        const agentSearch = document.getElementById('agent-search');
        const agentsContainer = document.getElementById('agents-container');
        const agentsEmpty = document.getElementById('agents-empty');
        
        // Agent modal elements
        const agentIdInput = document.getElementById('agent-id');
        const agentNameInput = document.getElementById('agent-name');
        const agentSlugInput = document.getElementById('agent-slug');
        const agentDescInput = document.getElementById('agent-description');
        const agentStatusInput = document.getElementById('agent-status');
        const agentRpmInput = document.getElementById('agent-rpm');
        const agentRunPermissionInput = document.getElementById('agent-run-permission');
        const confirmAgentBtn = document.getElementById('confirm-agent-btn');
        const deleteAgentBtn = document.getElementById('delete-agent-btn');
        const cancelAgentBtn = document.getElementById('cancel-agent-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

        // Modal toggle helper
        function toggleModal(modal, show) {
            if (show) {
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            } else {
                modal.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }
        }

        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Generate slug from name
        function generateSlug(name) {
            return name
                .toLowerCase()
                .replace(/[^\w\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/--+/g, '-')
                .trim();
        }

        // Update slug when name changes
        agentNameInput.addEventListener('input', function() {
            if (!agentIdInput.value) { // Only auto-generate for new agents
                const slug = generateSlug(this.value);
                agentSlugInput.value = slug;
            }
        });

        // Render agent card with futuristic design
        function renderAgentCard(agent) {
            const card = document.createElement('div');
            card.className = 'agent-card group relative bg-gradient-to-br from-card to-card/80 border border-border/50 rounded-2xl p-5 hover:border-primary/30 transition-all duration-300 hover:shadow-lg hover:shadow-primary/10';
            card.setAttribute('data-agent-id', agent.agent_id || agent.id);
            card.setAttribute('data-agent-name', (agent.agent_name || agent.name || '').toLowerCase());
            card.setAttribute('data-agent-description', (agent.description || '').toLowerCase());
            
            const statusColor = agent.status === 'active' ? 'bg-green-500/20 text-green-700' : 
                              agent.status === 'inactive' ? 'bg-gray-500/20 text-gray-700' : 
                              'bg-yellow-500/20 text-yellow-700';
            
            const statusDot = agent.status === 'active' ? 'bg-green-500' : 
                            agent.status === 'inactive' ? 'bg-gray-500' : 
                            'bg-yellow-500';
            
            card.innerHTML = `
                <div class="flex items-start justify-between mb-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-primary/10 to-primary/5 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-semibold text-foreground truncate">${escapeHtml(agent.agent_name || agent.name)}</h3>
                                <p class="text-xs text-muted-foreground">${agent.agent_slug || ''}</p>
                            </div>
                        </div>
                        <p class="text-sm text-muted-foreground line-clamp-2 mb-3">${escapeHtml(agent.description || 'No description')}</p>
                    </div>
                    <button class="agent-edit-btn opacity-0 group-hover:opacity-100 transition-opacity p-2 hover:bg-muted rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-muted-foreground" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </button>
                </div>
                
                <div class="space-y-3 pt-3 border-t border-border/50">
                    <div class="flex items-center justify-between">
                        <span class="inline-flex items-center gap-1.5 text-xs">
                            <span class="w-2 h-2 rounded-full ${statusDot}"></span>
                            <span class="${statusColor} px-2 py-0.5 rounded-full capitalize">${agent.status || 'unknown'}</span>
                        </span>
                        <span class="text-xs text-muted-foreground">
                            ${agent.limits?.rpm ? `${agent.limits.rpm} RPM` : ''}
                        </span>
                    </div>
                    
                    <div class="text-xs text-muted-foreground">
                        Created: ${formatDate(agent.created_at)}
                    </div>
                    
                    <div class="flex items-center gap-2 pt-2">
                        ${agent.permissions?.run ? `
                            <button class="run-agent-btn flex-1 bg-gradient-to-r from-primary to-primary/80 text-primary-foreground px-3 py-1.5 rounded-lg text-sm font-medium hover:opacity-90 transition-opacity flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Run
                            </button>
                        ` : ''}
                        <button class="open-agent-btn flex-1 bg-secondary text-secondary-foreground px-3 py-1.5 rounded-lg text-sm font-medium hover:bg-secondary/90 transition-colors">
                            Open
                        </button>
                        <button class="delete-agent-btn p-1.5 text-destructive hover:bg-destructive/10 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            
            // Add event listeners
            const editBtn = card.querySelector('.agent-edit-btn');
            const openBtn = card.querySelector('.open-agent-btn');
            const deleteBtn = card.querySelector('.delete-agent-btn');
            const runBtn = card.querySelector('.run-agent-btn');
            
            editBtn.addEventListener('click', () => openEditModal(agent));
            openBtn.addEventListener('click', () => window.location.href = `/agents/${agent.agent_id || agent.id}`);
            deleteBtn.addEventListener('click', () => openDeleteModal(agent));
            if (runBtn) {
                runBtn.addEventListener('click', () => runAgent(agent.agent_id || agent.id));
            }
            
            return card;
        }

        // Escape HTML to prevent XSS
        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // Load agents from backend
        async function loadAgents() {
            try {
                const res = await fetch('/dashboard/agents', { 
                    credentials: 'same-origin' 
                });

                let payload;
                try { 
                    payload = await res.json(); 
                } catch (e) { 
                    throw new Error('Failed to parse agent data'); 
                }

                if (!res.ok) {
                    const errMsg = payload?.message || 'Failed to fetch agents';
                    throw new Error(errMsg);
                }

                // Handle different response formats
                let agents = payload;
                if (!Array.isArray(agents)) {
                    if (agents?.data) agents = agents.data;
                    else if (agents?.agents) agents = agents.agents;
                    else agents = [];
                }

                agentsContainer.innerHTML = '';
                
                if (!agents || agents.length === 0) {
                    agentsEmpty.classList.remove('hidden');
                    return;
                }

                agentsEmpty.classList.add('hidden');
                
                // Sort by creation date (newest first)
                agents.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                agents.forEach(agent => {
                    const card = renderAgentCard(agent);
                    agentsContainer.appendChild(card);
                });

                // Apply search filter if any
                applyAgentFilter(agentSearch.value || '');
                
            } catch (err) {
                console.error('Error loading agents:', err);
                agentsContainer.innerHTML = '';
                agentsEmpty.classList.remove('hidden');
            }
        }

        // Apply search filter
        function applyAgentFilter(query) {
            const q = query.trim().toLowerCase();
            const cards = agentsContainer.querySelectorAll('.agent-card');
            let visibleCount = 0;
            
            cards.forEach(card => {
                const name = card.getAttribute('data-agent-name') || '';
                const desc = card.getAttribute('data-agent-description') || '';
                const show = !q || name.includes(q) || desc.includes(q);
                card.style.display = show ? 'block' : 'none';
                if (show) visibleCount++;
            });

            if (visibleCount === 0) {
                agentsEmpty.classList.remove('hidden');
            } else {
                agentsEmpty.classList.add('hidden');
            }
        }

        // Open create agent modal
        createAgentBtn.addEventListener('click', () => {
            agentIdInput.value = '';
            agentNameInput.value = '';
            agentSlugInput.value = '';
            agentDescInput.value = '';
            agentStatusInput.value = 'active';
            agentRpmInput.value = '10';
            agentRunPermissionInput.value = 'true';
            deleteAgentBtn.classList.add('hidden');
            document.getElementById('modal-title').textContent = 'Create New Agent';
            toggleModal(agentModal, true);
            agentNameInput.focus();
        });

        // Open edit agent modal
        function openEditModal(agent) {
            agentIdInput.value = agent.agent_id || agent.id;
            agentNameInput.value = agent.agent_name || agent.name || '';
            agentSlugInput.value = agent.agent_slug || generateSlug(agent.agent_name || agent.name || '');
            agentDescInput.value = agent.description || '';
            agentStatusInput.value = agent.status || 'active';
            agentRpmInput.value = agent.limits?.rpm || '10';
            agentRunPermissionInput.value = (agent.permissions?.run ?? true).toString();
            deleteAgentBtn.classList.remove('hidden');
            document.getElementById('modal-title').textContent = 'Edit Agent';
            toggleModal(agentModal, true);
        }

        // Open delete confirmation modal
        function openDeleteModal(agent) {
            const agentId = agent.agent_id || agent.id;
            const agentName = agent.agent_name || agent.name;
            
            document.getElementById('confirm-modal-message').textContent = 
                `Are you sure you want to delete "${agentName}"? This action cannot be undone.`;
            
            confirmDeleteBtn.onclick = () => deleteAgent(agentId);
            toggleModal(confirmModal, true);
        }

        // Save agent (create or update)
        confirmAgentBtn.addEventListener('click', async () => {
            const agentId = agentIdInput.value;
            const isEdit = !!agentId;
            
            const agentData = {
                agent_name: agentNameInput.value,
                agent_slug: agentSlugInput.value,
                description: agentDescInput.value,
                status: agentStatusInput.value,
                permissions: {
                    run: agentRunPermissionInput.value === 'true'
                },
                limits: {
                    rpm: parseInt(agentRpmInput.value) || 10
                }
            };

            try {
                const url = isEdit ? `/dashboard/update/${agentId}` : '/dashboard/create';
                const method = isEdit ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(agentData)
                });

                if (!res.ok) {
                    const errText = await res.text();
                    throw new Error(errText || 'Failed to save agent');
                }

                toggleModal(agentModal, false);
                loadAgents(); // Refresh the list
                
            } catch (err) {
                console.error('Error saving agent:', err);
                alert(`Failed to save agent: ${err.message}`);
            }
        });

        // Delete agent
        async function deleteAgent(agentId) {
            try {
                const res = await fetch(`/dashboard/delete/${agentId}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });

                if (!res.ok) {
                    const errText = await res.text();
                    throw new Error(errText || 'Failed to delete agent');
                }

                toggleModal(confirmModal, false);
                loadAgents(); // Refresh the list
                
            } catch (err) {
                console.error('Error deleting agent:', err);
                alert(`Failed to delete agent: ${err.message}`);
            }
        }

        // Run agent
        async function runAgent(agentId) {
            try {
                // You can implement the run logic here
                alert(`Running agent ${agentId}`);
                // Example: window.location.href = `/agents/${agentId}/run`;
            } catch (err) {
                console.error('Error running agent:', err);
                alert('Failed to run agent');
            }
        }

        // Cancel agent modal
        cancelAgentBtn.addEventListener('click', () => toggleModal(agentModal, false));
        cancelDeleteBtn.addEventListener('click', () => toggleModal(confirmModal, false));

        // Search functionality
        agentSearch.addEventListener('input', (e) => applyAgentFilter(e.target.value));
        
        // Refresh agents
        refreshAgentsBtn.addEventListener('click', loadAgents);

        // Initial load
        loadAgents();

        // --- API Key Modal Logic (existing) ---
        // ... (keep your existing API key modal logic here)
        // Note: I've removed the duplicate code to keep this response concise

    });
</script>

<style>
    .nav-item {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        color: hsl(var(--muted-foreground));
        font-weight: 500;
        transition: all 0.2s;
    }
    
    .nav-item:hover {
        background-color: hsl(var(--muted));
        color: hsl(var(--foreground));
    }
    
    .nav-item.active {
        background-color: hsl(var(--primary));
        color: hsl(var(--primary-foreground));
    }
    
    .nav-item svg {
        margin-right: 0.75rem;
    }
    
    .content-section {
        transition: opacity 0.3s;
    }

    /* Agent card animations */
    .agent-card {
        animation: fadeInUp 0.5s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Line clamp for descriptions */
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* Gradient borders */
    .gradient-border {
        position: relative;
        background: linear-gradient(white, white) padding-box,
                    linear-gradient(135deg, hsl(221.2 83.2% 53.3% / 0.3), hsl(221.2 83.2% 53.3% / 0.1)) border-box;
        border: 1px solid transparent;
    }

    /* Modal animations */
    .modal-enter {
        animation: modalEnter 0.3s ease-out;
    }

    @keyframes modalEnter {
        from {
            opacity: 0;
            transform: scale(0.95) translateY(-20px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    .hidden {
        display: none !important;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: hsl(var(--muted));
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
        background: hsl(var(--muted-foreground) / 0.3);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: hsl(var(--muted-foreground) / 0.5);
    }
</style>
{% endblock %}