{% extends 'base.html' %}

{% block title %}API Documentation{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <h1 class="text-3xl font-bold mb-6">API Documentation</h1>

  <style>
    /* Seamless three-panel layout overrides for api docs */
    .api-docs-panels { display: grid; grid-template-columns: 320px 1fr 420px; gap: 0; height: 70vh; }
    .api-docs-panels .card { border: none; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); box-shadow: 0 8px 30px rgba(2,6,23,0.55); border-radius: 12px; overflow: hidden; }
    .api-docs-panels .panel { padding: 1rem 1.25rem; height: 100%; box-sizing: border-box; }
    .nav-panel { border-top-left-radius: 12px; border-bottom-left-radius: 12px; }
    .code-panel { border-top-right-radius: 12px; border-bottom-right-radius: 12px; }
    .middle-panel { border-left: 1px solid rgba(255,255,255,0.03); border-right: 1px solid rgba(255,255,255,0.03); }
    /* subtle inner separators to visually group content without harsh boxes */
    .api-docs-panels .panel > h2, .api-docs-panels .panel > h3 { margin-top: 0; }
    .endpoint-list li + li { margin-top: 0.25rem; }
    .endpoint-path { font-size: 0.95rem; }
    /* make code sample area more prominent */
    #code-block, #details-request, #details-response { background: rgba(0,0,0,0.18); border-radius: 8px; padding: 0.9rem; }
  </style>

  <div class="api-docs-panels">
    <!-- Left: Navigation -->
    <aside id="api-nav" class="panel nav-panel card">
      <div style="padding-top:0.25rem;">
        <h2 class="font-semibold text-lg mb-3">Categories</h2>
        <div id="categories-list" class="endpoint-list space-y-2" style="padding-bottom:1rem;">
          <!-- Filled by JS -->
        </div>
      </div>
    </aside>

    <!-- Middle: Details -->
    <section id="api-details" class="panel middle-panel card">
      <div>
        <h2 id="details-title" class="text-xl font-semibold mb-2">Select an endpoint</h2>
        <p id="details-summary" class="text-sm text-muted-foreground mb-4">Choose a category and endpoint from the left to see details and code examples.</p>

        <div id="details-meta" class="mb-4">
          <div class="flex items-center space-x-3 mb-2">
            <span id="details-method" class="badge badge-primary"></span>
            <code id="details-path" class="text-sm font-mono"></code>
          </div>

          <div id="details-description" class="prose prose-sm text-muted-foreground"></div>
        </div>

        <div id="details-request-response">
          <h3 class="font-semibold mt-4">Request</h3>
          <pre id="details-request" class="bg-input p-3 rounded text-sm overflow-auto"><code>// Request JSON will appear here</code></pre>

          <h3 class="font-semibold mt-4">Response</h3>
          <pre id="details-response" class="bg-input p-3 rounded text-sm overflow-auto"><code>// Response JSON will appear here</code></pre>
        </div>
      </div>
    </section>

    <!-- Right: Code examples -->
    <aside id="api-code" class="panel code-panel card">
      <div>
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-semibold">Code Samples</h3>
          <div class="flex space-x-2">
            <button id="copy-code" class="btn-secondary text-xs">Copy</button>
          </div>
        </div>

        <div class="mb-3">
          <label for="code-lang" class="text-sm text-muted-foreground">Language</label>
          <select id="code-lang" class="input w-full mt-1">
            <option value="curl">curl</option>
            <option value="python">Python</option>
            <option value="js">JavaScript</option>
          </select>
        </div>

        <pre id="code-block" class="bg-input p-3 rounded text-sm overflow-auto"><code>// Code sample will appear here</code></pre>
      </div>
    </aside>
  </div>
</div>

<script>
// Basic client-side renderer for the API docs page.
(async function () {
  const navEl = document.getElementById('categories-list');
  const detailsTitle = document.getElementById('details-title');
  const detailsSummary = document.getElementById('details-summary');
  const detailsMethod = document.getElementById('details-method');
  const detailsPath = document.getElementById('details-path');
  const detailsDescription = document.getElementById('details-description');
  const detailsRequest = document.getElementById('details-request').querySelector('code');
  const detailsResponse = document.getElementById('details-response').querySelector('code');
  const codeBlock = document.getElementById('code-block').querySelector('code');
  const codeLang = document.getElementById('code-lang');
  const copyBtn = document.getElementById('copy-code');

  async function fetchData() {
    // Use absolute static URLs to avoid template quoting issues
    const origin = window.location.origin.replace(/\/$/, '');
    const candidates = [
      `${origin}/static/Api_References/index.json`,
      `${origin}/static/index.json`
    ];

    for (const url of candidates) {
      try {
        const res = await fetch(url);
        if (!res.ok) continue;
        const data = await res.json();
        // Replace any placeholder base tokens in all code samples
        try {
          const asString = JSON.stringify(data);
          const replaced = asString.replace(/__BASE__|\{\{BASE\}\}/g, window.location.origin);
          return JSON.parse(replaced);
        } catch (e) {
          return data; // if replacement fails, return raw
        }
      } catch (e) {
        console.warn('Failed to fetch', url, e);
        // try next candidate
        continue;
      }
    }

    console.warn('All fetch attempts failed, using minimal fallback');
    return { categories: [] };
  }

  const docs = await fetchData();

  /* Small styles for API nav method pills */
  const styleEl = document.createElement('style');
  styleEl.textContent = `
    .method-pill { display: inline-flex; align-items: center; justify-content: center; min-width: 48px; padding: 0.18rem 0.5rem; border-radius: 0.375rem; font-weight: 700; font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.6px; }
    .method-get { background: rgba(16, 185, 129, 0.12); color: #10b981; border: 1px solid rgba(16,185,129,0.18); }
    .method-post { background: rgba(59,130,246,0.10); color: #3b82f6; border: 1px solid rgba(59,130,246,0.16); }
    .method-other { background: rgba(107,114,128,0.08); color: #6b7280; border: 1px solid rgba(107,114,128,0.12); }
  `;
  document.head.appendChild(styleEl);

  function renderNav(data) {
    navEl.innerHTML = '';
    data.categories.forEach((cat, ci) => {
      const catEl = document.createElement('div');
      const title = document.createElement('div');
      title.className = 'font-semibold mb-1';
      title.textContent = cat.name;
      catEl.appendChild(title);

      const list = document.createElement('ul');
      list.className = 'space-y-1 ml-2';

      cat.endpoints.forEach((ep, ei) => {
        const li = document.createElement('li');
        const btn = document.createElement('button');
        btn.className = 'w-full text-left text-sm py-2 px-2 rounded hover:bg-secondary hover:text-primary flex items-center gap-3';

        // Method pill
        const methodSpan = document.createElement('span');
        const method = (ep.method || '').toUpperCase();
        methodSpan.textContent = method;
        methodSpan.className = 'method-pill';
        if (method === 'GET') methodSpan.classList.add('method-get');
        else if (method === 'POST') methodSpan.classList.add('method-post');
        else methodSpan.classList.add('method-other');

        // Path text
        const pathSpan = document.createElement('span');
        pathSpan.className = 'endpoint-path';
        pathSpan.textContent = `${ep.path}`;

        btn.appendChild(methodSpan);
        btn.appendChild(pathSpan);

        btn.onclick = () => selectEndpoint(cat, ep);
        li.appendChild(btn);
        list.appendChild(li);
      });

      catEl.appendChild(list);
      navEl.appendChild(catEl);
    });
  }

  function prettyJSON(v) {
    try { return JSON.stringify(v, null, 2); } catch (e) { return String(v); }
  }

  function selectEndpoint(category, ep) {
    detailsTitle.textContent = ep.summary || ep.path;
    detailsSummary.textContent = category.name + ' â€” ' + (ep.summary || '');
    detailsMethod.textContent = ep.method;
    detailsPath.textContent = ep.path;
    detailsDescription.textContent = ep.description || '';
    detailsRequest.textContent = ep.request ? prettyJSON(ep.request) : '// No request body for this endpoint';
    detailsResponse.textContent = ep.response ? prettyJSON(ep.response) : '// No response example provided';

    // Update code block based on selected language
    const lang = codeLang.value || 'curl';
    const code = (ep.code && ep.code[lang]) ? ep.code[lang] : (ep.code && ep.code.curl) || '// No code sample';
    codeBlock.textContent = code.replace(/\{\{BASE\}\}/g, window.location.origin);
  }

  codeLang.addEventListener('change', () => {
    // If an endpoint is selected, update code sample language
    const selectedPath = detailsPath.textContent;
    if (!selectedPath) return;
    // Find endpoint in docs
    let found;
    docs.categories.some(cat => cat.endpoints.some(ep => { if (ep.path === selectedPath) { found = ep; return true; } }));
    if (found) {
      const code = (found.code && found.code[codeLang.value]) ? found.code[codeLang.value] : (found.code && found.code.curl) || '// No code sample';
      codeBlock.textContent = code.replace(/\{\{BASE\}\}/g, window.location.origin);
    }
  });

  copyBtn.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(codeBlock.textContent);
      copyBtn.textContent = 'Copied';
      setTimeout(() => (copyBtn.textContent = 'Copy'), 1500);
    } catch (e) {
      console.warn('Copy failed', e);
    }
  });

  renderNav(docs);
  // Auto-select first endpoint if present
  if (docs.categories && docs.categories.length && docs.categories[0].endpoints && docs.categories[0].endpoints[0]) {
    selectEndpoint(docs.categories[0], docs.categories[0].endpoints[0]);
  }
})();
</script>

{% endblock %}
